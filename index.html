<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sponsorship Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .connection-status {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        #connection-status {
            color: #27ae60;
            font-weight: 600;
        }

        #connection-status.disconnected {
            color: #e74c3c;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .summary-item .label {
            font-weight: 600;
        }

        .summary-item .value {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .value.income {
            color: #27ae60;
        }

        .value.cost {
            color: #e74c3c;
        }

        .value.deficit {
            color: #c0392b;
        }

        .chart-container {
            height: 200px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            margin-top: 20px;
        }

        .chart-bar {
            width: 50px;
            background-color: #3498db;
            border-radius: 5px 5px 0 0;
            position: relative;
            transition: height 0.5s ease;
        }

        .chart-bar.negative {
            background-color: #e74c3c;
        }

        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .recommendation {
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid;
        }

        .recommendation.priority-high {
            border-left-color: #e74c3c;
            background-color: #ffeaea;
        }

        .recommendation.priority-medium {
            border-left-color: #f39c12;
            background-color: #fff4e6;
        }

        .recommendation h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .recommendation ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .management-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
        }

        .stat {
            text-align: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .stat-label {
            display: block;
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .students-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .students-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .students-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .student-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .student-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .student-actions {
            display: flex;
            gap: 5px;
        }

        .student-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
        }

        .detail-label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .program-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-button:hover {
            color: #3498db;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background-color: #f5f7fa;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #7f8c8d;
        }

        .close:hover {
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        /* Real-time update notification */
        .update-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #27ae60;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .management-actions {
                flex-direction: column;
            }
            
            .program-tabs {
                flex-direction: column;
            }
            
            .tab-button {
                text-align: left;
                border-bottom: 1px solid #ddd;
                border-left: 3px solid transparent;
            }
            
            .tab-button.active {
                border-left-color: #3498db;
                border-bottom-color: #ddd;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .student-details {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 15px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            .student-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .student-actions {
                align-self: flex-end;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status Indicators */
        .status-active {
            color: #27ae60;
            font-weight: 600;
        }

        .status-inactive {
            color: #e74c3c;
            font-weight: 600;
        }

        .status-pending {
            color: #f39c12;
            font-weight: 600;
        }

        /* Financial Highlighting */
        .positive {
            color: #27ae60;
            font-weight: 600;
        }

        .negative {
            color: #e74c3c;
            font-weight: 600;
        }

        .neutral {
            color: #7f8c8d;
            font-weight: 600;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted #3498db;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #2c3e50;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Sponsorship Management System</h1>
            <p>Financial Analysis & Planning Tool</p>
            <div class="connection-status">
                <span id="connection-status">Connected</span>
                <span id="last-updated">Last updated: Just now</span>
            </div>
        </header>

        <div class="dashboard">
            <div class="card summary-card">
                <h2>Financial Overview</h2>
                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="label">Confirmed Monthly Income</span>
                        <span class="value income" id="total-income">€2,848</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Projected Monthly Costs</span>
                        <span class="value cost" id="total-costs">€5,804</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Monthly Deficit</span>
                        <span class="value deficit" id="total-deficit">-€2,956</span>
                    </div>
                </div>
            </div>

            <div class="card gap-card">
                <h2>Funding Gap by Program</h2>
                <div id="funding-gap-chart" class="chart-container">
                    <!-- Chart will be rendered here -->
                </div>
            </div>

            <div class="card recommendations-card">
                <h2>Recommendations</h2>
                <div class="recommendations-list">
                    <div class="recommendation priority-high">
                        <h3>Immediate Priority: Address Funding Gap</h3>
                        <p>The system is structurally underfunded with a monthly deficit of €2,956</p>
                        <ul>
                            <li>Launch campaign to find sponsors for inactive/underfunded students</li>
                            <li>Critically review budgeted items for potential savings</li>
                            <li>Formally prioritize which students/programs can be fully funded</li>
                        </ul>
                    </div>
                    <div class="recommendation priority-medium">
                        <h3>Create Integrated Data System</h3>
                        <p>Eliminate manual data entry errors and ensure consistency</p>
                        <ul>
                            <li>Implement automatic data linking between registry and financial planning</li>
                            <li>Use single master database with real-time synchronization</li>
                            <li>This system is the first step toward that goal</li>
                        </ul>
                    </div>
                    <div class="recommendation priority-medium">
                        <h3>Standardize Assumptions</h3>
                        <p>Ensure consistent calculations across all programs</p>
                        <ul>
                            <li>Use single exchange rate (4100 UGX = 1 EUR)</li>
                            <li>Standardize cost calculations in centralized location</li>
                            <li>Update assumptions in one place to propagate changes everywhere</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="card data-management-card">
                <h2>Data Management</h2>
                <div class="management-actions">
                    <button id="add-program" class="btn btn-primary">Add Program</button>
                    <button id="add-student" class="btn btn-primary">Add Student</button>
                    <button id="refresh-data" class="btn btn-secondary">Refresh Data</button>
                    <button id="export-data" class="btn btn-secondary">Export Report</button>
                </div>
                <div class="data-stats">
                    <div class="stat">
                        <span class="stat-label">Total Students</span>
                        <span class="stat-value" id="total-students">149</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Active Sponsorships</span>
                        <span class="stat-value" id="active-sponsorships">98</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Monthly Funding</span>
                        <span class="stat-value" id="monthly-funding">€4,413</span>
                    </div>
                </div>
            </div>

            <div class="card students-card">
                <h2>Student Management</h2>
                <div class="students-controls">
                    <select id="program-select">
                        <option value="">Select Program</option>
                        <option value="CH">CH</option>
                        <option value="YSP">YSP</option>
                        <option value="ICCSP">ICCSP</option>
                        <option value="OTM_GA">OTM-GA</option>
                    </select>
                    <button id="load-students" class="btn btn-primary">Load Students</button>
                </div>
                <div id="students-list" class="students-list">
                    <!-- Students will be loaded here -->
                </div>
            </div>

            <div class="card program-details-card">
                <h2>Program Details</h2>
                <div class="program-tabs">
                    <button class="tab-button active" data-program="all">All Programs</button>
                    <button class="tab-button" data-program="CH">CH</button>
                    <button class="tab-button" data-program="YSP">YSP</button>
                    <button class="tab-button" data-program="ICCSP">ICCSP</button>
                    <button class="tab-button" data-program="OTM_GA">OTM-GA</button>
                </div>
                <div class="program-content">
                    <table id="program-table">
                        <thead>
                            <tr>
                                <th>Program</th>
                                <th>Students</th>
                                <th>Monthly Income</th>
                                <th>Monthly Costs</th>
                                <th>Deficit/Surplus</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Program data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals for CRUD operations -->
    <div id="program-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modal-title">Add New Program</h3>
            <form id="program-form">
                <div class="form-group">
                    <label for="program-code">Program Code:</label>
                    <input type="text" id="program-code" required>
                </div>
                <div class="form-group">
                    <label for="program-name">Program Name:</label>
                    <input type="text" id="program-name" required>
                </div>
                <button type="submit" class="btn btn-primary">Save Program</button>
            </form>
        </div>
    </div>

    <div id="student-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="student-modal-title">Add New Student</h3>
            <form id="student-form">
                <div class="form-group">
                    <label for="student-program">Program:</label>
                    <select id="student-program" required>
                        <option value="">Select Program</option>
                        <option value="CH">CH</option>
                        <option value="YSP">YSP</option>
                        <option value="ICCSP">ICCSP</option>
                        <option value="OTM_GA">OTM-GA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="full-name">Full Name:</label>
                    <input type="text" id="full-name" required>
                </div>
                <div class="form-group">
                    <label for="sponsorship-package">Sponsorship Package:</label>
                    <select id="sponsorship-package" required>
                        <option value="Day">Day</option>
                        <option value="Boarding">Boarding</option>
                        <option value="Day Sec">Day Secondary</option>
                        <option value="Boarding Sec">Boarding Secondary</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="termly-fees">Termly School Fees (UGX):</label>
                    <input type="number" id="termly-fees" value="0">
                </div>
                <div class="form-group">
                    <label for="cash-received">Monthly Cash Received (EUR):</label>
                    <input type="number" id="cash-received" value="0">
                </div>
                <button type="submit" class="btn btn-primary">Save Student</button>
            </form>
        </div>
    </div>

    <script>
       // Global variables
let database = {};
let financialSummary = {};
let fundingGap = {};
let currentProgram = '';
let ws = null;

// DOM Content Loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeWebSocket();
    loadData();
    setupEventListeners();
    setupModals();
});

// Initialize WebSocket for real-time updates
function initializeWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}`;
    
    ws = new WebSocket(wsUrl);
    
    ws.onopen = function() {
        console.log('WebSocket connected');
        updateConnectionStatus(true);
    };
    
    ws.onmessage = function(event) {
        const message = JSON.parse(event.data);
        handleWebSocketMessage(message);
    };
    
    ws.onclose = function() {
        console.log('WebSocket disconnected');
        updateConnectionStatus(false);
        // Attempt to reconnect after 5 seconds
        setTimeout(initializeWebSocket, 5000);
    };
    
    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
        updateConnectionStatus(false);
    };
}

// Handle WebSocket messages
function handleWebSocketMessage(message) {
    switch (message.type) {
        case 'database_loaded':
        case 'database_update':
            database = message.data;
            showNotification('Database updated in real-time');
            updateUI();
            break;
            
        case 'program_updated':
            database.sponsorship_programs[message.program] = message.data;
            showNotification(message.message);
            updateUI();
            break;
            
        case 'student_added':
        case 'student_updated':
        case 'student_deleted':
            showNotification(message.message);
            if (currentProgram === message.program) {
                loadStudents(currentProgram);
            }
            updateUI();
            break;
    }
}

// Update connection status
function updateConnectionStatus(connected) {
    const statusElement = document.getElementById('connection-status');
    if (connected) {
        statusElement.textContent = 'Connected';
        statusElement.classList.remove('disconnected');
    } else {
        statusElement.textContent = 'Disconnected';
        statusElement.classList.add('disconnected');
    }
}

// Load data from server
async function loadData() {
    try {
        showLoading(true);
        
        const response = await fetch('/api/data');
        if (!response.ok) throw new Error('Network response was not ok');
        
        database = await response.json();
        
        const financialResponse = await fetch('/api/financial-summary');
        financialSummary = await financialResponse.json();
        
        const gapResponse = await fetch('/api/funding-gap');
        fundingGap = await gapResponse.json();
        
        updateUI();
        showNotification('Data loaded successfully');
    } catch (error) {
        console.error('Error loading data:', error);
        showNotification('Failed to load data. Please check if server is running.', 'error');
    } finally {
        showLoading(false);
    }
}

// Setup event listeners
function setupEventListeners() {
    // Refresh data button
    document.getElementById('refresh-data').addEventListener('click', loadData);
    
    // Export data button
    document.getElementById('export-data').addEventListener('click', exportData);
    
    // Load students button
    document.getElementById('load-students').addEventListener('click', () => {
        const program = document.getElementById('program-select').value;
        if (program) {
            loadStudents(program);
        } else {
            showNotification('Please select a program', 'error');
        }
    });
    
    // Program tabs
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            filterProgramTable(this.getAttribute('data-program'));
        });
    });
}

// Setup modals
function setupModals() {
    // Program modal
    const programModal = document.getElementById('program-modal');
    const programBtn = document.getElementById('add-program');
    const programClose = programModal.querySelector('.close');
    
    programBtn.onclick = function() {
        programModal.style.display = 'block';
        document.getElementById('modal-title').textContent = 'Add New Program';
        document.getElementById('program-form').reset();
    };
    
    programClose.onclick = function() {
        programModal.style.display = 'none';
    };
    
    // Student modal
    const studentModal = document.getElementById('student-modal');
    const studentBtn = document.getElementById('add-student');
    const studentClose = studentModal.querySelector('.close');
    
    studentBtn.onclick = function() {
        studentModal.style.display = 'block';
        document.getElementById('student-modal-title').textContent = 'Add New Student';
        document.getElementById('student-form').reset();
    };
    
    studentClose.onclick = function() {
        studentModal.style.display = 'none';
    };
    
    // Close modals when clicking outside
    window.onclick = function(event) {
        if (event.target === programModal) {
            programModal.style.display = 'none';
        }
        if (event.target === studentModal) {
            studentModal.style.display = 'none';
        }
    };
    
    // Form submissions
    document.getElementById('program-form').onsubmit = handleProgramSubmit;
    document.getElementById('student-form').onsubmit = handleStudentSubmit;
}

// Handle program form submission
async function handleProgramSubmit(e) {
    e.preventDefault();
    
    const programCode = document.getElementById('program-code').value.toUpperCase();
    const programName = document.getElementById('program-name').value;
    
    const programData = {
        program_name: programName,
        students: [],
        metadata: {
            total_students: 0,
            sponsorship_types: {}
        }
    };
    
    try {
        const response = await fetch(`/api/programs/${programCode}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(programData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message);
            document.getElementById('program-modal').style.display = 'none';
            loadData();
        } else {
            showNotification('Error: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Error creating program:', error);
        showNotification('Failed to create program', 'error');
    }
}

// Handle student form submission
async function handleStudentSubmit(e) {
    e.preventDefault();
    
    const program = document.getElementById('student-program').value;
    const fullName = document.getElementById('full-name').value;
    const sponsorshipPackage = document.getElementById('sponsorship-package').value;
    const termlyFees = parseInt(document.getElementById('termly-fees').value) || 0;
    const cashReceived = parseInt(document.getElementById('cash-received').value) || 0;
    
    const studentData = {
        full_name: fullName,
        sponsorship_package: sponsorshipPackage,
        financial_data: {
            termly_school_fees: termlyFees,
            cash_received_euro: cashReceived
        }
    };
    
    try {
        const response = await fetch(`/api/programs/${program}/students`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(studentData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message);
            document.getElementById('student-modal').style.display = 'none';
            if (currentProgram === program) {
                loadStudents(program);
            }
            loadData();
        } else {
            showNotification('Error: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Error creating student:', error);
        showNotification('Failed to create student', 'error');
    }
}

// Load students for a program
async function loadStudents(program) {
    try {
        const response = await fetch(`/api/programs/${program}`);
        const programData = await response.json();
        
        const studentsList = document.getElementById('students-list');
        studentsList.innerHTML = '';
        
        if (programData.students && programData.students.length > 0) {
            programData.students.forEach(student => {
                const studentElement = createStudentElement(student, program);
                studentsList.appendChild(studentElement);
            });
        } else {
            studentsList.innerHTML = '<p>No students found for this program.</p>';
        }
        
        currentProgram = program;
        showNotification(`Loaded ${programData.students?.length || 0} students from ${program}`);
    } catch (error) {
        console.error('Error loading students:', error);
        document.getElementById('students-list').innerHTML = '<p>Error loading students.</p>';
        showNotification('Failed to load students', 'error');
    }
}

// Create student element
function createStudentElement(student, program) {
    const studentDiv = document.createElement('div');
    studentDiv.className = 'student-item';
    
    const financialData = student.financial_data || {};
    
    // Calculate actual values from formulas
    const calculatedData = calculateFinancialData(financialData);
    
    studentDiv.innerHTML = `
        <div class="student-header">
            <div class="student-name">${student.full_name}</div>
            <div class="student-actions">
                <button class="btn btn-primary btn-sm edit-student" data-id="${student.serial_number}">Edit</button>
                <button class="btn btn-danger btn-sm delete-student" data-id="${student.serial_number}">Delete</button>
            </div>
        </div>
        <div class="student-details">
            <div class="detail-item">
                <span class="detail-label">Package:</span>
                <span>${student.sponsorship_package}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Termly Fees:</span>
                <span>${calculatedData.termly_school_fees.toLocaleString()} UGX</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Monthly Fees:</span>
                <span>${calculatedData.direct_spending_school_fees_ugx_monthly.toLocaleString()} UGX</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Cash Received:</span>
                <span>${calculatedData.cash_received_euro} EUR</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Monthly Cost:</span>
                <span class="${calculatedData.monthly_output_euro >= 0 ? 'positive' : 'negative'}">
                    ${calculatedData.monthly_output_euro.toFixed(2)} EUR
                </span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Balance:</span>
                <span class="${calculatedData.plus_minus_diff_euro >= 0 ? 'positive' : 'negative'}">
                    ${calculatedData.plus_minus_diff_euro.toFixed(2)} EUR
                </span>
            </div>
        </div>
    `;
    
    // Add event listeners to buttons
    studentDiv.querySelector('.edit-student').addEventListener('click', () => {
        editStudent(student, program);
    });
    
    studentDiv.querySelector('.delete-student').addEventListener('click', () => {
        deleteStudent(student.serial_number, program);
    });
    
    return studentDiv;
}

// Calculate financial data from formulas
function calculateFinancialData(financialData) {
    const result = { ...financialData };
    
    // Convert formula strings to actual numbers
    Object.keys(financialData).forEach(key => {
        if (typeof financialData[key] === 'string' && financialData[key].startsWith('=')) {
            result[key] = evaluateFormula(financialData[key], financialData);
        } else if (financialData[key] === null) {
            result[key] = 0;
        }
    });
    
    return result;
}

// Simple formula evaluator
function evaluateFormula(formula, data) {
    try {
        // Remove the = sign and replace cell references with actual values
        let expression = formula.substring(1);
        
        // Replace common Excel-style formulas
        expression = expression
            .replace(/SUM\(([^)]+)\)/g, (match, range) => {
                const parts = range.split(':');
                return parts.reduce((sum, part) => sum + (parseFloat(data[part]) || 0), 0);
            })
            .replace(/(\d+)%/g, '$1/100')
            .replace(/\*/g, '*')
            .replace(/\//g, '/');
        
        // Simple evaluation (in production, use a proper formula parser)
        return eval(expression) || 0;
    } catch (error) {
        console.error('Error evaluating formula:', formula, error);
        return 0;
    }
}

// Edit student
function editStudent(student, program) {
    document.getElementById('student-modal').style.display = 'block';
    document.getElementById('student-modal-title').textContent = 'Edit Student';
    
    document.getElementById('student-program').value = program;
    document.getElementById('full-name').value = student.full_name;
    document.getElementById('sponsorship-package').value = student.sponsorship_package;
    document.getElementById('termly-fees').value = student.financial_data?.termly_school_fees || 0;
    document.getElementById('cash-received').value = student.financial_data?.cash_received_euro || 0;
    
    // Update form submission to handle edit
    const form = document.getElementById('student-form');
    const originalSubmit = form.onsubmit;
    
    form.onsubmit = async function(e) {
        e.preventDefault();
        
        const updates = {
            full_name: document.getElementById('full-name').value,
            sponsorship_package: document.getElementById('sponsorship-package').value,
            financial_data: {
                ...student.financial_data,
                termly_school_fees: parseInt(document.getElementById('termly-fees').value) || 0,
                cash_received_euro: parseInt(document.getElementById('cash-received').value) || 0
            }
        };
        
        try {
            const response = await fetch(`/api/programs/${program}/students/${student.serial_number}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updates)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification(result.message);
                document.getElementById('student-modal').style.display = 'none';
                loadStudents(program);
                loadData();
                // Restore original submit handler
                form.onsubmit = originalSubmit;
            } else {
                showNotification('Error: ' + result.message, 'error');
            }
        } catch (error) {
            console.error('Error updating student:', error);
            showNotification('Failed to update student', 'error');
        }
    };
}

// Delete student
async function deleteStudent(studentId, program) {
    if (confirm('Are you sure you want to delete this student?')) {
        try {
            const response = await fetch(`/api/programs/${program}/students/${studentId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification(result.message);
                loadStudents(program);
                loadData();
            } else {
                showNotification('Error: ' + result.message, 'error');
            }
        } catch (error) {
            console.error('Error deleting student:', error);
            showNotification('Failed to delete student', 'error');
        }
    }
}

// Update UI with loaded data
function updateUI() {
    // Update financial summary
    document.getElementById('total-income').textContent = `€${financialSummary.totalIncome.toLocaleString()}`;
    document.getElementById('total-costs').textContent = `€${financialSummary.totalCosts.toLocaleString()}`;
    document.getElementById('total-deficit').textContent = `-€${Math.abs(financialSummary.totalDeficit).toLocaleString()}`;
    
    // Update data stats
    document.getElementById('total-students').textContent = database.metadata.programs_summary.total_students_across_all_programs;
    document.getElementById('active-sponsorships').textContent = database.metadata.programs_summary.total_active_sponsorships;
    document.getElementById('monthly-funding').textContent = `€${database.metadata.programs_summary.total_monthly_funding_euros}`;
    
    // Render funding gap chart
    renderFundingGapChart();
    
    // Populate program table
    populateProgramTable();
    
    // Update last updated time
    document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
}

// Render funding gap chart
function renderFundingGapChart() {
    const chartContainer = document.getElementById('funding-gap-chart');
    chartContainer.innerHTML = '';
    
    if (fundingGap.programs && fundingGap.programs.length > 0) {
        const maxDeficit = Math.max(...fundingGap.programs.map(p => Math.abs(p.deficit)));
        
        fundingGap.programs.forEach(program => {
            const barHeight = (Math.abs(program.deficit) / maxDeficit) * 180;
            const bar = document.createElement('div');
            bar.className = `chart-bar ${program.deficit < 0 ? 'negative' : ''}`;
            bar.style.height = `${barHeight}px`;
            
            const label = document.createElement('div');
            label.className = 'chart-label';
            label.textContent = program.name;
            
            const value = document.createElement('div');
            value.className = 'chart-value';
            value.textContent = `€${Math.abs(program.deficit).toFixed(0)}`;
            value.style.position = 'absolute';
            value.style.top = '-25px';
            value.style.left = '0';
            value.style.right = '0';
            value.style.textAlign = 'center';
            value.style.fontSize = '0.8rem';
            value.style.fontWeight = '600';
            
            bar.appendChild(value);
            bar.appendChild(label);
            chartContainer.appendChild(bar);
        });
    }
}

// Populate program table
function populateProgramTable() {
    const tableBody = document.querySelector('#program-table tbody');
    tableBody.innerHTML = '';
    
    // Add rows for each program
    const programs = Object.keys(database.sponsorship_programs);
    
    programs.forEach(program => {
        const programData = database.sponsorship_programs[program];
        const registryData = database.sponsorship_registry[program];
        const programGap = fundingGap.programs ? fundingGap.programs.find(p => p.name === program) : null;
        
        if (programData) {
            const row = document.createElement('tr');
            
            // Program name
            const nameCell = document.createElement('td');
            nameCell.textContent = program;
            row.appendChild(nameCell);
            
            // Students count
            const studentsCell = document.createElement('td');
            studentsCell.textContent = programData.metadata.total_students;
            row.appendChild(studentsCell);
            
            // Monthly income
            const incomeCell = document.createElement('td');
            const income = registryData?.metadata?.total_monthly_funding || 0;
            incomeCell.textContent = `€${income}`;
            row.appendChild(incomeCell);
            
            // Monthly costs
            const costsCell = document.createElement('td');
            const costs = programGap ? programGap.costs : 0;
            costsCell.textContent = `€${costs.toFixed(0)}`;
            row.appendChild(costsCell);
            
            // Deficit/Surplus
            const deficitCell = document.createElement('td');
            const deficit = programGap ? programGap.deficit : 0;
            deficitCell.textContent = `€${deficit.toFixed(0)}`;
            deficitCell.className = deficit >= 0 ? 'positive' : 'negative';
            row.appendChild(deficitCell);
            
            tableBody.appendChild(row);
        }
    });
}

// Filter program table
function filterProgramTable(program) {
    const rows = document.querySelectorAll('#program-table tbody tr');
    
    rows.forEach(row => {
        if (program === 'all' || row.cells[0].textContent === program) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Export data
function exportData() {
    // Create a CSV string with the financial summary
    let csvContent = "Sponsorship Management System - Financial Report\n\n";
    csvContent += "Financial Summary\n";
    csvContent += `Confirmed Monthly Income,€${financialSummary.totalIncome}\n`;
    csvContent += `Projected Monthly Costs,€${financialSummary.totalCosts}\n`;
    csvContent += `Monthly Deficit,€${financialSummary.totalDeficit}\n\n`;
    
    csvContent += "Funding Gap by Program\n";
    if (fundingGap.programs) {
        fundingGap.programs.forEach(program => {
            csvContent += `${program.name},€${program.deficit.toFixed(2)}\n`;
        });
    }
    
    csvContent += "\nStudent Details\n";
    csvContent += "Program,Student Name,Package,Termly Fees,Monthly Cost,Cash Received,Balance\n";
    
    Object.entries(database.sponsorship_programs).forEach(([program, programData]) => {
        programData.students.forEach(student => {
            const financialData = student.financial_data || {};
            const calculatedData = calculateFinancialData(financialData);
            csvContent += `${program},${student.full_name},${student.sponsorship_package},${calculatedData.termly_school_fees},${calculatedData.monthly_output_euro.toFixed(2)},${calculatedData.cash_received_euro},${calculatedData.plus_minus_diff_euro.toFixed(2)}\n`;
        });
    });
    
    // Create a blob and download link
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sponsorship_financial_report.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('Report exported successfully');
}

// Show notification
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = 'update-notification';
    notification.textContent = message;
    
    if (type === 'error') {
        notification.style.backgroundColor = '#e74c3c';
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Show loading state
function showLoading(loading) {
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(button => {
        if (loading) {
            button.disabled = true;
            button.classList.add('loading');
        } else {
            button.disabled = false;
            button.classList.remove('loading');
        }
    });
}
    </script>
</body>
</html>
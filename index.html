<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sponsorship Management System | Professional Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Add your CSS here -->
    <style>
         :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #17a2b8;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --gray-light: #bdc3c7;
            --white: #ffffff;
            --sidebar-width: 280px;
            --header-height: 70px;
            --border-radius: 12px;
            --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s ease;
        }

        /* ===== BASE STYLES ===== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary);
            color: var(--white);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 1000;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 25px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .sidebar-header h2 {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .sidebar-header h2 i {
            color: var(--secondary);
            font-size: 1.6rem;
        }

        .nav-links {
            padding: 20px 0;
        }

        .nav-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
            margin: 5px 0;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(52, 152, 219, 0.2);
            border-left-color: var(--secondary);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .nav-item span {
            font-weight: 500;
            font-size: 0.95rem;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            background: #f8f9fa;
            min-height: 100vh;
        }

        /* ===== HEADER ===== */
        .header {
            height: var(--header-height);
            background: var(--white);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 35px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .search-container {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-box {
            width: 100%;
            padding: 14px 50px 14px 20px;
            border: 2px solid var(--gray-light);
            border-radius: 30px;
            font-size: 14px;
            transition: var(--transition);
            background: var(--light);
        }

        .search-box:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: var(--white);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1.1rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            background: var(--light);
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .connection-status:hover {
            background: #dde4e6;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: var(--danger);
            animation: none;
        }

        .status-dot.offline {
            background: var(--warning);
            animation: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: var(--secondary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-info {
            background: var(--info);
            color: var(--white);
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-light {
            background: var(--light);
            color: var(--dark);
        }

        .btn-light:hover {
            background: #dde4e6;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-lg {
            padding: 16px 32px;
            font-size: 1.1rem;
        }

        /* ===== DASHBOARD ===== */
        .dashboard {
            padding: 35px;
        }

        /* Welcome Banner */
        .welcome-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--white);
            padding: 40px;
            border-radius: var(--border-radius);
            margin-bottom: 35px;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }

        .welcome-banner::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        .welcome-banner h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .welcome-banner p {
            opacity: 0.9;
            font-size: 1.2rem;
            max-width: 600px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border-left: 5px solid var(--secondary);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--secondary);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-card.income {
            border-left-color: var(--success);
        }

        .stat-card.income::before {
            background: var(--success);
        }

        .stat-card.cost {
            border-left-color: var(--warning);
        }

        .stat-card.cost::before {
            background: var(--warning);
        }

        .stat-card.deficit {
            border-left-color: var(--danger);
        }

        .stat-card.deficit::before {
            background: var(--danger);
        }

        .stat-icon {
            width: 70px;
            height: 70px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            background: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
        }

        .stat-card.income .stat-icon {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .stat-card.cost .stat-icon {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        .stat-card.deficit .stat-icon {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--dark), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.income .stat-value {
            background: linear-gradient(135deg, var(--success), #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-card.cost .stat-value {
            background: linear-gradient(135deg, var(--warning), #f1c40f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-card.deficit .stat-value {
            background: linear-gradient(135deg, var(--danger), #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 35px;
        }

        .chart-card {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .chart-card:hover {
            transform: translateY(-5px);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .chart-header h3 {
            font-size: 1.4rem;
            color: var(--dark);
            font-weight: 700;
        }

        .chart-container {
            height: 320px;
            position: relative;
        }

        /* Search Section */
        .search-section {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 35px;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 25px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title i {
            color: var(--secondary);
        }

        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px 16px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 14px;
            transition: var(--transition);
            background: var(--white);
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .search-results {
            margin-top: 25px;
        }

        .result-card {
            background: var(--light);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .result-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.12);
        }

        /* Students Section */
        .students-section {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .section-header h3 {
            font-size: 1.5rem;
            color: var(--dark);
            font-weight: 700;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            background: var(--white);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            min-width: 1000px;
        }

        .data-table th {
            background: var(--primary);
            color: var(--white);
            padding: 18px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table th:first-child {
            border-top-left-radius: var(--border-radius);
        }

        .data-table th:last-child {
            border-top-right-radius: var(--border-radius);
        }

        .data-table td {
            padding: 16px;
            border-bottom: 1px solid var(--gray-light);
            font-size: 0.9rem;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-active {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
            border: 1px solid rgba(39, 174, 96, 0.2);
        }

        .status-inactive {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        .status-pending {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
            border: 1px solid rgba(243, 156, 18, 0.2);
        }

        /* Positive/Negative Colors */
        .positive {
            color: var(--success);
            font-weight: 600;
        }

        .negative {
            color: var(--danger);
            font-weight: 600;
        }

        .neutral {
            color: var(--gray);
            font-weight: 600;
        }

        /* ===== MODALS ===== */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--white);
            margin: 5% auto;
            padding: 0;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 650px;
            position: relative;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary);
            color: var(--white);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .modal-header h3 {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: var(--white);
            transition: var(--transition);
            opacity: 0.8;
        }

        .close:hover {
            opacity: 1;
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 14px 16px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 14px;
            transition: var(--transition);
            background: var(--white);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            background: var(--light);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        /* ===== NOTIFICATIONS ===== */
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 18px 24px;
            border-radius: var(--border-radius);
            color: var(--white);
            box-shadow: var(--box-shadow);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background: var(--success);
            border-left: 4px solid #2ecc71;
        }

        .notification.error {
            background: var(--danger);
            border-left: 4px solid #c0392b;
        }

        .notification.warning {
            background: var(--warning);
            border-left: 4px solid #e67e22;
        }

        .notification.info {
            background: var(--info);
            border-left: 4px solid #138496;
        }

        /* ===== LOADING STATES ===== */
        .loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== EMPTY STATES ===== */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h4 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .empty-state p {
            font-size: 1rem;
            max-width: 400px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                width: 300px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .header {
                padding: 0 25px;
            }
            
            .dashboard {
                padding: 25px;
            }
        }

        @media (max-width: 768px) {
            .welcome-banner h1 {
                font-size: 2rem;
            }
            
            .welcome-banner p {
                font-size: 1.1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            .search-filters {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }

        @media (max-width: 576px) {
            .header {
                flex-direction: column;
                height: auto;
                padding: 15px;
                gap: 15px;
            }
            
            .search-container {
                max-width: 100%;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .dashboard {
                padding: 20px 15px;
            }
            
            .welcome-banner {
                padding: 25px;
            }
            
            .chart-card,
            .search-section,
            .students-section {
                padding: 20px;
            }
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            .sidebar, .header, .action-buttons {
                display: none;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .dashboard {
                padding: 0;
            }
            
            .stat-card, .chart-card, .search-section, .students-section {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }

        /* ===== AI ASSISTANT CHAT ===== */
        .ai-assistant-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            z-index: 5000;
            background: linear-gradient(135deg, #3498db 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .ai-assistant-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #3498db 100%);
            box-shadow: 0 12px 40px rgba(0,0,0,0.22);
        }
        .ai-chat-box {
            position: fixed;
            bottom: 110px;
            right: 32px;
            width: 350px;
            max-width: 95vw;
            height: 420px;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.18);
            z-index: 5001;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #3498db;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(60px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .ai-chat-header {
            background: linear-gradient(135deg, #3498db 0%, #764ba2 100%);
            color: #fff;
            padding: 16px 20px;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .ai-chat-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.3rem;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .ai-chat-close:hover {
            opacity: 1;
        }
        .ai-chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #f7f8fa;
        }
        .ai-chat-message {
            margin-bottom: 14px;
            display: flex;
            align-items: flex-start;
        }
        .ai-chat-message.user {
            justify-content: flex-end;
        }
        .ai-chat-bubble {
            max-width: 80%;
            padding: 10px 16px;
            border-radius: 14px;
            font-size: 0.98rem;
            background: #3498db;
            color: #fff;
            box-shadow: 0 2px 8px rgba(52,152,219,0.08);
            word-break: break-word;
        }
        .ai-chat-message.user .ai-chat-bubble {
            background: #764ba2;
            color: #fff;
        }
        .ai-chat-message.ai .ai-chat-bubble {
            background: #3498db;
            color: #fff;
        }
        .ai-chat-input {
            display: flex;
            padding: 12px 16px;
            border-top: 1px solid #eee;
            background: #fff;
        }
        .ai-chat-input input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
            outline: none;
            margin-right: 8px;
        }
        .ai-chat-input button {
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .ai-chat-input button:hover {
            background: #764ba2;
        }

        /* Sponsors Section Styles */
        .sponsors-section {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 35px;
        }

        /* Add these status badge colors if not already present */
        .status-badge.status-pending {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
            border: 1px solid rgba(243, 156, 18, 0.2);
        }

        /* Financial Analysis Section */
        .financial-analysis-section {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 35px;
        }

        /* Settings Section */
        .settings-section {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 35px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .settings-card {
            background: var(--light);
            padding: 25px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--secondary);
        }

        .settings-card h4 {
            margin-bottom: 15px;
            color: var(--dark);
            font-size: 1.2rem;
        }

        .logo-upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 20px;
            border: 2px dashed var(--gray-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .logo-upload-container:hover {
            border-color: var(--secondary);
            background: rgba(52, 152, 219, 0.05);
        }

        .logo-preview {
            max-width: 200px;
            max-height: 100px;
            display: none;
        }

        /* Event Reminders */
        .events-section {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 35px;
        }

        .event-card {
            background: var(--light);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            border-left: 4px solid var(--info);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-card.upcoming {
            border-left-color: var(--warning);
        }

        .event-card.urgent {
            border-left-color: var(--danger);
        }

        .event-date {
            font-weight: 600;
            color: var(--dark);
            background: var(--white);
            padding: 5px 10px;
            border-radius: 6px;
        }

        /* Forex Exchange */
        .forex-section {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 35px;
        }

        .forex-card {
            background: var(--light);
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .forex-rate {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--secondary);
            margin: 10px 0;
        }

        /* Daily Expenses */
        .expenses-section {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 35px;
        }

        .expense-category {
            margin-bottom: 25px;
        }

        .expense-category h4 {
            margin-bottom: 15px;
            color: var(--dark);
            font-size: 1.2rem;
            border-bottom: 2px solid var(--light);
            padding-bottom: 8px;
        }

        /* Import/Export Section */
        .import-export-section {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 35px;
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .export-card {
            background: var(--light);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .export-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .export-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--secondary);
        }
    
        /* Your CSS styles go here */
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-hand-holding-heart"></i> <span id="org-name">Sponsorship Pro</span></h2>
            </div>
            <div class="nav-links">
                <div class="nav-item active" data-section="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard Overview</span>
                </div>
                <div class="nav-item" data-section="students">
                    <i class="fas fa-user-graduate"></i>
                    <span>Students Management</span>
                </div>
                <div class="nav-item" data-section="sponsors">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span>Sponsors Registry</span>
                </div>
                <div class="nav-item" data-section="financials">
                    <i class="fas fa-chart-pie"></i>
                    <span>Financial Analysis</span>
                </div>
                <div class="nav-item" data-section="expenses">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Daily Expenses</span>
                </div>
                <div class="nav-item" data-section="search">
                    <i class="fas fa-search"></i>
                    <span>Advanced Search</span>
                </div>
                <div class="nav-item" data-section="analytics">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </div>
                <div class="nav-item" data-section="events">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Event Reminders</span>
                </div>
                <div class="nav-item" data-section="forex">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Forex Exchange</span>
                </div>
                <div class="nav-item" data-section="import-export">
                    <i class="fas fa-file-export"></i>
                    <span>Import/Export</span>
                </div>
                <div class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>System Settings</span>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Header with Search and Actions -->
            <div class="header">
                <div class="search-container">
                    <input type="text" class="search-box" id="global-search" placeholder="Search students, sponsors, programs, financial records...">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="header-actions">
                    <button id="ai-assistant-toggle" class="btn btn-primary">
                        <i class="fas fa-robot"></i> AI Assistant
                    </button>
                    <div class="connection-status" id="connection-toggle">
                        <div class="status-dot" id="connection-dot"></div>
                        <span id="connection-text">Connected</span>
                    </div>
                    <button class="btn btn-primary" id="sync-now">
                        <i class="fas fa-sync-alt"></i> Sync Now
                    </button>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="dashboard">
                <!-- Welcome Banner -->
                <div class="welcome-banner">
                    <h1>Sponsorship Management Dashboard</h1>
                    <p>Comprehensive overview of all sponsorship programs, financial analytics, and student management</p>
                </div>

                <!-- Key Statistics Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value" id="total-students">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card income">
                        <div class="stat-icon">
                            <i class="fas fa-euro-sign"></i>
                        </div>
                        <div class="stat-value" id="total-income">€0</div>
                        <div class="stat-label">Monthly Income</div>
                    </div>
                    <div class="stat-card cost">
                        <div class="stat-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-value" id="total-costs">€0</div>
                        <div class="stat-label">Monthly Costs</div>
                    </div>
                    <div class="stat-card deficit">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line-down"></i>
                        </div>
                        <div class="stat-value" id="total-deficit">€0</div>
                        <div class="stat-label">Monthly Deficit</div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Funding Gap Analysis</h3>
                            <button class="btn btn-sm btn-info" onclick="exportChartData()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="funding-gap-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Program Distribution</h3>
                            <button class="btn btn-sm btn-info" onclick="refreshCharts()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="program-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Advanced Search Section -->
                <div class="search-section" id="search-section">
                    <h3 class="section-title"><i class="fas fa-search"></i> Advanced Search</h3>
                    <div class="search-filters">
                        <div class="filter-group">
                            <label for="search-type">Search Type</label>
                            <select id="search-type">
                                <option value="all">All Records</option>
                                <option value="students">Students Only</option>
                                <option value="sponsors">Sponsors Only</option>
                                <option value="programs">Programs Only</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="search-program">Program</label>
                            <select id="search-program">
                                <option value="">All Programs</option>
                                <option value="CH">CH Program</option>
                                <option value="YSP">YSP Program</option>
                                <option value="ICCSP">ICCSP Program</option>
                                <option value="OTM_GA">OTM-GA Program</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="search-status">Status</label>
                            <select id="search-status">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="search-package">Sponsorship Package</label>
                            <select id="search-package">
                                <option value="">All Packages</option>
                                <option value="Day">Day Program</option>
                                <option value="Boarding">Boarding Program</option>
                                <option value="Day Sec">Day Secondary</option>
                                <option value="Boarding Sec">Boarding Secondary</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="perform-search">
                        <i class="fas fa-search"></i> Perform Search
                    </button>
                    <div class="search-results" id="search-results">
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h4>No Search Results</h4>
                            <p>Use the search filters above to find students, sponsors, or program records</p>
                        </div>
                    </div>
                </div>

                <!-- Students Management Section -->
                <div class="students-section" id="students-section">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fas fa-user-graduate"></i> Students Management</h3>
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="add-student-btn">
                                <i class="fas fa-plus"></i> Add Student
                            </button>
                            <button class="btn btn-success" id="export-data">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                            <button class="btn btn-info" id="refresh-data">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="students-table">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Program</th>
                                    <th>Package</th>
                                    <th>Termly Fees</th>
                                    <th>Cash Received</th>
                                    <th>Monthly Cost</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body">
                                <tr>
                                    <td colspan="9">
                                        <div class="empty-state">
                                            <i class="fas fa-user-graduate"></i>
                                            <h4>Loading Students Data</h4>
                                            <p>Please wait while we load the student information...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sponsors Registry Section -->
                <div class="sponsors-section" id="sponsors-section" style="display: none;">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fas fa-hand-holding-usd"></i> Sponsors Registry</h3>
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="add-sponsor-btn">
                                <i class="fas fa-plus"></i> Add Sponsor
                            </button>
                            <button class="btn btn-success" id="export-sponsors">
                                <i class="fas fa-download"></i> Export Sponsors
                            </button>
                            <button class="btn btn-info" id="refresh-sponsors">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Sponsors Summary Cards -->
                    <div class="stats-grid" style="margin-bottom: 25px;">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-value" id="total-sponsors">0</div>
                            <div class="stat-label">Total Sponsors</div>
                        </div>
                        <div class="stat-card income">
                            <div class="stat-icon">
                                <i class="fas fa-euro-sign"></i>
                            </div>
                            <div class="stat-value" id="active-sponsors-income">€0</div>
                            <div class="stat-label">Monthly Sponsorship</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="stat-value" id="active-sponsors">0</div>
                            <div class="stat-label">Active Sponsors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-user-clock"></i>
                            </div>
                            <div class="stat-value" id="inactive-sponsors">0</div>
                            <div class="stat-label">Inactive Sponsors</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table" id="sponsors-table">
                            <thead>
                                <tr>
                                    <th>Sponsor Name</th>
                                    <th>Sponsored Student</th>
                                    <th>Program</th>
                                    <th>Amount (EUR)</th>
                                    <th>Amount (UGX)</th>
                                    <th>Status</th>
                                    <th>Category</th>
                                    <th>Start Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sponsors-table-body">
                                <tr>
                                    <td colspan="9">
                                        <div class="empty-state">
                                            <i class="fas fa-hand-holding-usd"></i>
                                            <h4>Loading Sponsors Data</h4>
                                            <p>Please wait while we load the sponsors information...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Financial Analysis Section -->
                <div class="financial-analysis-section" id="financials-section" style="display: none;">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fas fa-chart-pie"></i> Financial Analysis</h3>
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="generate-report">
                                <i class="fas fa-file-alt"></i> Generate Report
                            </button>
                            <button class="btn btn-info" id="refresh-financials">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="stats-grid" style="margin-bottom: 25px;">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="stat-value" id="monthly-expenses">UGX 0</div>
                            <div class="stat-label">Monthly Expenses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div class="stat-value" id="termly-expenses">UGX 0</div>
                            <div class="stat-label">Termly Expenses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-year"></i>
                            </div>
                            <div class="stat-value" id="yearly-expenses">UGX 0</div>
                            <div class="stat-label">Yearly Expenses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-balance-scale"></i>
                            <div class="stat-value" id="budget-balance">UGX 0</div>
                                <div class="stat-label">Budget Balance</div>
                            </div>
                        </div>
                    </div>

                    <div class="charts-section">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>Expense Breakdown</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="expense-breakdown-chart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>Income vs Expenses Trend</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="income-expense-trend-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Expenses Section -->
                <div class="expenses-section" id="expenses-section" style="display: none;">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fas fa-money-bill-wave"></i> Daily Expenses Tracking</h3>
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="add-expense-btn">
                                <i class="fas fa-plus"></i> Add Expense
                            </button>
                            <button class="btn btn-info" id="refresh-expenses">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="expense-category">
                        <h4>School Expenses</h4>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Student</th>
                                        <th>Description</th>
                                        <th>Amount (UGX)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="school-expenses-body">
                                    <!-- School expenses will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="expense-category">
                        <h4>Medical Expenses</h4>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Student</th>
                                        <th>Description</th>
                                        <th>Amount (UGX)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="medical-expenses-body">
                                    <!-- Medical expenses will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="expense-category">
                        <h4>Transport Expenses</h4>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Student</th>
                                        <th>Description</th>
                                        <th>Amount (UGX)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transport-expenses-body">
                                    <!-- Transport expenses will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Event Reminders Section -->
                <div class="events-section" id="events-section" style="display: none;">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fas fa-calendar-alt"></i> Event Reminders</h3>
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="add-event-btn">
                                <i class="fas fa-plus"></i> Add Event
                            </button>
                            <button class="btn btn-info" id="refresh-events">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div id="events-container">
                        <div class="empty-state">
                            <i class="fas fa-calendar-alt"></i>
                            <h4>No Upcoming Events</h4>
                            <p>Add events to get reminders for important dates and deadlines</p>
                        </div>
                    </div>
                </div>

                <!-- Forex Exchange Section -->
                <div class="forex-section" id="forex-section" style="display: none;">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fas fa-exchange-alt"></i> Forex Exchange</h3>
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="update-forex">
                                <i class="fas fa-sync"></i> Update Rates
                            </button>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="forex-card">
                            <h4>EUR to UGX</h4>
                            <div class="forex-rate" id="eur-to-ugx-rate">1 EUR = 4,100 UGX</div>
                            <p>Last updated: <span id="forex-update-time">Just now</span></p>
                        </div>
                        <div class="forex-card">
                            <h4>Currency Converter</h4>
                            <div class="form-group">
                                <input type="number" id="forex-amount" placeholder="Enter amount" value="1">
                            </div>
                            <div class="form-group">
                                <select id="forex-from">
                                    <option value="EUR">EUR</option>
                                    <option value="UGX">UGX</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <select id="forex-to">
                                    <option value="UGX">UGX</option>
                                    <option value="EUR">EUR</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="convert-currency">Convert</button>
                            <div class="forex-rate" id="conversion-result" style="margin-top: 15px;">-</div>
                        </div>
                    </div>
                </div>

                <!-- Import/Export Section -->
                <div class="import-export-section" id="import-export-section" style="display: none;">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fas fa-file-export"></i> Import/Export Data</h3>
                    </div>

                    <div class="export-options">
                        <div class="export-card" onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i>
                            <h4>Export to Excel</h4>
                            <p>Download data in Excel format for further analysis</p>
                        </div>
                        <div class="export-card" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf"></i>
                            <h4>Export to PDF</h4>
                            <p>Generate professional PDF reports</p>
                        </div>
                        <div class="export-card" onclick="showImportModal()">
                            <i class="fas fa-file-import"></i>
                            <h4>Import Data</h4>
                            <p>Upload Excel files to update your database</p>
                        </div>
                        <div class="export-card" onclick="backupData()">
                            <i class="fas fa-database"></i>
                            <h4>Backup Data</h4>
                            <p>Create a complete backup of your system</p>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="settings-section" id="settings-section" style="display: none;">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fas fa-cog"></i> System Settings</h3>
                    </div>

                    <div class="settings-grid">
                        <div class="settings-card">
                            <h4>Organization Settings</h4>
                            <div class="form-group">
                                <label for="org-name-input">Organization Name</label>
                                <input type="text" id="org-name-input" value="Sponsorship Pro">
                            </div>
                            <div class="form-group">
                                <label for="org-currency">Default Currency</label>
                                <select id="org-currency">
                                    <option value="EUR">Euro (EUR)</option>
                                    <option value="UGX">Ugandan Shilling (UGX)</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="saveOrgSettings()">Save Settings</button>
                        </div>

                        <div class="settings-card">
                            <h4>Logo Upload</h4>
                            <div class="logo-upload-container" id="logo-upload-area">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem;"></i>
                                <p>Click to upload your organization logo</p>
                                <input type="file" id="logo-upload" accept="image/*" style="display: none;">
                                <img id="logo-preview" class="logo-preview" src="" alt="Logo Preview">
                            </div>
                        </div>

                        <div class="settings-card">
                            <h4>Exchange Rate Settings</h4>
                            <div class="form-group">
                                <label for="manual-exchange-rate">Manual Exchange Rate (EUR to UGX)</label>
                                <input type="number" id="manual-exchange-rate" value="4100" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="auto-update-forex">
                                    <input type="checkbox" id="auto-update-forex"> Auto-update exchange rates
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="saveForexSettings()">Save Forex Settings</button>
                        </div>

                        <div class="settings-card">
                            <h4>Notification Settings</h4>
                            <div class="form-group">
                                <label for="email-notifications">
                                    <input type="checkbox" id="email-notifications" checked> Email notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="event-reminders">
                                    <input type="checkbox" id="event-reminders" checked> Event reminders
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="low-balance-alerts">
                                    <input type="checkbox" id="low-balance-alerts" checked> Low balance alerts
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="saveNotificationSettings()">Save Notification Settings</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Chat Box -->
    <div class="ai-chat-box" id="ai-chat-box" style="display: none;">
        <div class="ai-chat-header">
            <span>AI Assistant</span>
            <button class="ai-chat-close" id="ai-chat-close">&times;</button>
        </div>
        <div class="ai-chat-messages" id="ai-chat-messages">
            <div class="ai-chat-message ai">
                <div class="ai-chat-bubble">
                    Hello! I'm your sponsorship management assistant. How can I help you today?
                </div>
            </div>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="ai-chat-input" placeholder="Type your message...">
            <button id="ai-chat-send">Send</button>
        </div>
    </div>
    <button class="ai-assistant-btn" id="ai-assistant-btn">
        <i class="fas fa-robot"></i>
    </button>

    <!-- Student Management Modal -->
    <div id="student-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="student-modal-title">Add New Student</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="student-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="student-program">Program *</label>
                            <select id="student-program" required>
                                <option value="">Select Program</option>
                                <option value="CH">CH Program</option>
                                <option value="YSP">YSP Program</option>
                                <option value="ICCSP">ICCSP Program</option>
                                <option value="OTM_GA">OTM-GA Program</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="full-name">Full Name *</label>
                            <input type="text" id="full-name" required placeholder="Enter student's full name">
                        </div>
                        <div class="form-group">
                            <label for="sponsorship-package">Sponsorship Package *</label>
                            <select id="sponsorship-package" required>
                                <option value="Day">Day Program</option>
                                <option value="Boarding">Boarding Program</option>
                                <option value="Day Sec">Day Secondary</option>
                                <option value="Boarding Sec">Boarding Secondary</option>
                                <option value="Day Van">Day Van</option>
                                <option value="Boarding SN">Boarding SN</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="termly-fees">Termly School Fees (UGX)</label>
                            <input type="number" id="termly-fees" value="0" placeholder="Enter termly fees in UGX">
                        </div>
                        <div class="form-group">
                            <label for="cash-received">Monthly Cash Received (EUR)</label>
                            <input type="number" id="cash-received" value="0" placeholder="Enter monthly cash in EUR">
                        </div>
                        <div class="form-group full-width">
                            <label for="student-notes">Additional Notes</label>
                            <textarea id="student-notes" rows="3" placeholder="Any additional information about the student..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" id="cancel-student">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" form="student-form" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Student
                </button>
            </div>
        </div>
    </div>

    <!-- Sponsor Management Modal -->
    <div id="sponsor-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="sponsor-modal-title">Add New Sponsor</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="sponsor-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="sponsor-program">Program *</label>
                            <select id="sponsor-program" required>
                                <option value="">Select Program</option>
                                <option value="CH">CH Program</option>
                                <option value="YSP">YSP Program</option>
                                <option value="ICCSP">ICCSP Program</option>
                                <option value="OTM_GA">OTM-GA Program</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sponsor-name">Sponsor Name *</label>
                            <input type="text" id="sponsor-name" required placeholder="Enter sponsor's full name">
                        </div>
                        <div class="form-group">
                            <label for="sponsored-student">Sponsored Student *</label>
                            <select id="sponsored-student" required>
                                <option value="">Select Student</option>
                                <!-- Students will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sponsor-amount">Monthly Amount (EUR) *</label>
                            <input type="number" id="sponsor-amount" required min="0" step="0.01" placeholder="Enter monthly amount in EUR">
                        </div>
                        <div class="form-group">
                            <label for="sponsor-status">Sponsorship Status *</label>
                            <select id="sponsor-status" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sponsor-category">Category</label>
                            <select id="sponsor-category">
                                <option value="Individual">Individual</option>
                                <option value="Organization">Organization</option>
                                <option value="Foundation">Foundation</option>
                                <option value="Corporate">Corporate</option>
                                <option value="Government">Government</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sponsor-start-date">Start Date</label>
                            <input type="date" id="sponsor-start-date">
                        </div>
                        <div class="form-group full-width">
                            <label for="sponsor-notes">Additional Notes</label>
                            <textarea id="sponsor-notes" rows="3" placeholder="Any additional information about the sponsor..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" id="cancel-sponsor">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" form="sponsor-form" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Sponsor
                </button>
            </div>
        </div>
    </div>

    <!-- Expense Management Modal -->
    <div id="expense-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="expense-modal-title">Add New Expense</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="expense-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="expense-date">Date *</label>
                            <input type="date" id="expense-date" required>
                        </div>
                        <div class="form-group">
                            <label for="expense-student">Student *</label>
                            <select id="expense-student" required>
                                <option value="">Select Student</option>
                                <!-- Students will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expense-category">Category *</label>
                            <select id="expense-category" required>
                                <option value="school">School</option>
                                <option value="medical">Medical</option>
                                <option value="transport">Transport</option>
                                <option value="food">Food</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expense-amount">Amount (UGX) *</label>
                            <input type="number" id="expense-amount" required min="0" placeholder="Enter amount in UGX">
                        </div>
                        <div class="form-group full-width">
                            <label for="expense-description">Description *</label>
                            <textarea id="expense-description" rows="3" required placeholder="Describe the expense..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" id="cancel-expense">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" form="expense-form" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Expense
                </button>
            </div>
        </div>
    </div>

    <!-- Event Management Modal -->
    <div id="event-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="event-modal-title">Add New Event</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="event-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="event-title">Event Title *</label>
                            <input type="text" id="event-title" required placeholder="Enter event title">
                        </div>
                        <div class="form-group">
                            <label for="event-date">Date *</label>
                            <input type="date" id="event-date" required>
                        </div>
                        <div class="form-group">
                            <label for="event-type">Event Type *</label>
                            <select id="event-type" required>
                                <option value="meeting">Meeting</option>
                                <option value="deadline">Deadline</option>
                                <option value="payment">Payment Due</option>
                                <option value="report">Report Due</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="event-priority">Priority</label>
                            <select id="event-priority">
                                <option value="normal">Normal</option>
                                <option value="important">Important</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="event-description">Description</label>
                            <textarea id="event-description" rows="3" placeholder="Event details..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" id="cancel-event">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" form="event-form" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Event
                </button>
            </div>
        </div>
    </div>

    <!-- Import Data Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import Data</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="import-type">Data Type</label>
                    <select id="import-type">
                        <option value="students">Students</option>
                        <option value="sponsors">Sponsors</option>
                        <option value="expenses">Expenses</option>
                        <option value="all">All Data</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="import-file">Select Excel File</label>
                    <input type="file" id="import-file" accept=".xlsx, .xls">
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" id="process-import">
                        <i class="fas fa-upload"></i> Process Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
      // ===== GLOBAL VARIABLES =====
let database = {};
let financialSummary = {
    totalStudents: 0,
    totalIncomeEUR: 0,
    totalIncomeUGX: 0,
    totalCostsEUR: 0,
    totalCostsUGX: 0,
    totalDeficitEUR: 0,
    totalDeficitUGX: 0
};
let fundingGap = { programs: [], totalDeficitEUR: 0, totalDeficitUGX: 0 };
let allStudents = [];
let allSponsors = [];
let dailyExpenses = [];
let events = [];
let ws = null;
let currentSection = 'dashboard';
let isConnected = false;
let isOnlineMode = true;
let fundingChart = null;
let programChart = null;
let expenseChart = null;
let trendChart = null;
let EXCHANGE_RATE = 4100; // 1 EUR = 4100 UGX

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Initializing Sponsorship Management System...');
    initializeApplication();
});

async function initializeApplication() {
    try {
        setupEventListeners();
        setupModals();
        setupNavigation();
        await loadData();
        initializeWebSocket();
        loadSettings();
        checkEventReminders();
        console.log('✅ Application initialized successfully');
    } catch (error) {
        console.error('❌ Failed to initialize application:', error);
        showNotification('Failed to initialize application. Using sample data.', 'error');
        loadSampleData();
    }
}

// ===== WEB SOCKET MANAGEMENT =====
function initializeWebSocket() {
    if (!isOnlineMode) return;

    try {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}`;
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('🔗 WebSocket connected successfully');
            isConnected = true;
            updateConnectionStatus(true, 'online');
        };
        
        ws.onmessage = function(event) {
            try {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            } catch (error) {
                console.error('❌ Error parsing WebSocket message:', error);
            }
        };
        
        ws.onclose = function() {
            console.log('🔌 WebSocket disconnected');
            isConnected = false;
            updateConnectionStatus(false, 'online');
            
            if (isOnlineMode) {
                setTimeout(() => {
                    if (!isConnected) initializeWebSocket();
                }, 3000);
            }
        };
        
        ws.onerror = function(error) {
            console.error('❌ WebSocket error:', error);
            isConnected = false;
            updateConnectionStatus(false, 'online');
        };
        
    } catch (error) {
        console.error('❌ WebSocket initialization failed:', error);
        isConnected = false;
        updateConnectionStatus(false, 'online');
    }
}

function handleWebSocketMessage(message) {
    console.log('📨 WebSocket message:', message.type);
    
    switch (message.type) {
        case 'database_loaded':
        case 'database_update':
            database = message.data;
            processAllData();
            updateUI();
            showNotification('Data updated in real-time', 'success');
            break;
            
        case 'program_updated':
            if (database.sponsorship_programs) {
                database.sponsorship_programs[message.program] = message.data;
            }
            processAllData();
            updateUI();
            showNotification(message.message, 'success');
            break;
            
        case 'student_added':
        case 'student_updated':
        case 'student_deleted':
        case 'sponsor_added':
        case 'sponsor_updated':
        case 'sponsor_deleted':
            showNotification(message.message, 'success');
            loadData();
            break;
    }
}

// ===== DATA MANAGEMENT =====
async function loadData() {
    try {
        showLoading(true);
        console.log('📡 Loading data from server...');
        
        if (isOnlineMode) {
            const dataResponse = await fetch('/api/data');
            if (!dataResponse.ok) {
                throw new Error(`Server error: ${dataResponse.status}`);
            }
            
            const dataResult = await dataResponse.json();
            console.log('📊 Data received:', dataResult);

            // Extract data from different response formats
            if (dataResult.sponsorship_programs !== undefined) {
                database = dataResult;
            } else if (dataResult.data && dataResult.data.sponsorship_programs) {
                database = dataResult.data;
            } else if (dataResult.success && dataResult.data) {
                database = dataResult.data;
            } else {
                database = dataResult;
            }
            
            // Save to localStorage for offline use
            localStorage.setItem('sponsorshipData', JSON.stringify(database));
        } else {
            const localData = localStorage.getItem('sponsorshipData');
            if (localData) {
                database = JSON.parse(localData);
            } else {
                throw new Error('No local data available');
            }
        }
        
        // Load additional data
        await loadExpenses();
        await loadEvents();
        
        processAllData();
        updateUI();
        showNotification('Data loaded successfully!', 'success');
        
    } catch (error) {
        console.error('❌ Error loading data:', error);
        showNotification(`Failed to load data: ${error.message}. Using sample data.`, 'error');
        loadSampleData();
    } finally {
        showLoading(false);
    }
}

async function loadExpenses() {
    try {
        const expensesResponse = await fetch('/api/expenses');
        if (expensesResponse.ok) {
            const result = await expensesResponse.json();
            dailyExpenses = result.data || [];
        } else {
            throw new Error('Failed to load expenses');
        }
    } catch (error) {
        console.error('Error loading expenses:', error);
        // Fallback to localStorage
        const expensesData = localStorage.getItem('dailyExpenses');
        if (expensesData) {
            dailyExpenses = JSON.parse(expensesData);
        } else {
            dailyExpenses = [];
        }
    }
}

async function loadEvents() {
    try {
        const eventsResponse = await fetch('/api/events');
        if (eventsResponse.ok) {
            const result = await eventsResponse.json();
            events = result.data || [];
        } else {
            throw new Error('Failed to load events');
        }
    } catch (error) {
        console.error('Error loading events:', error);
        // Fallback to localStorage
        const eventsData = localStorage.getItem('events');
        if (eventsData) {
            events = JSON.parse(eventsData);
        } else {
            events = [];
        }
    }
}

function processAllData() {
    console.log('🔄 Processing data...');
    allStudents = [];
    allSponsors = [];
    
    // Process students
    if (database.sponsorship_programs) {
        Object.entries(database.sponsorship_programs).forEach(([program, programData]) => {
            if (programData && programData.students) {
                programData.students.forEach(student => {
                    const financialData = calculateFinancialData(student.financial_data || {});
                    allStudents.push({
                        ...student,
                        program: program,
                        program_name: programData.program_name,
                        calculated_financials: financialData,
                        type: 'student',
                        status: 'active'
                    });
                });
            }
        });
    }
    
    // Process sponsors
    if (database.sponsorship_registry) {
        Object.entries(database.sponsorship_registry).forEach(([program, registryData]) => {
            if (registryData && registryData.students) {
                registryData.students.forEach(sponsor => {
                    allSponsors.push({
                        ...sponsor,
                        program: program,
                        type: 'sponsor'
                    });
                });
            }
        });
    }
    
    calculateRealTimeFinancials();
    fundingGap = calculateFundingGapFromData();
    
    console.log(`✅ Processed ${allStudents.length} students and ${allSponsors.length} sponsors`);
}

function calculateRealTimeFinancials() {
    console.log('🧮 Calculating financials...');
    
    // Calculate total students
    const totalStudents = allStudents.length;
    
    // Calculate total income from active sponsors
    let totalIncomeEUR = 0;
    allSponsors.forEach(sponsor => {
        if (sponsor.sponsorship_status === 'active' || !sponsor.sponsorship_status) {
            totalIncomeEUR += parseFloat(sponsor.amount) || 0;
        }
    });
    const totalIncomeUGX = totalIncomeEUR * EXCHANGE_RATE;
    
    // Calculate total costs from students
    let totalCostsUGX = 0;
    allStudents.forEach(student => {
        const financials = student.calculated_financials || {};
        totalCostsUGX += parseFloat(financials.monthly_output_ugx) || 0;
    });
    const totalCostsEUR = totalCostsUGX / EXCHANGE_RATE;
    
    // Calculate deficit
    const totalDeficitUGX = totalIncomeUGX - totalCostsUGX;
    const totalDeficitEUR = totalDeficitUGX / EXCHANGE_RATE;
    
    financialSummary = {
        totalStudents,
        totalIncomeEUR,
        totalIncomeUGX,
        totalCostsEUR,
        totalCostsUGX,
        totalDeficitEUR,
        totalDeficitUGX
    };
    
    console.log('💰 Financial summary:', financialSummary);
}

function calculateFundingGapFromData() {
    const programs = {};
    
    // Group students by program
    allStudents.forEach(student => {
        if (!programs[student.program]) {
            programs[student.program] = {
                name: student.program,
                incomeEUR: 0,
                incomeUGX: 0,
                costsUGX: 0,
                costsEUR: 0,
                studentCount: 0
            };
        }
        
        const financials = student.calculated_financials || {};
        programs[student.program].costsUGX += parseFloat(financials.monthly_output_ugx) || 0;
        programs[student.program].studentCount++;
    });
    
    // Add sponsor income by program
    allSponsors.forEach(sponsor => {
        if ((sponsor.sponsorship_status === 'active' || !sponsor.sponsorship_status) && programs[sponsor.program]) {
            programs[sponsor.program].incomeEUR += parseFloat(sponsor.amount) || 0;
        }
    });
    
    // Convert and calculate deficits
    const programArray = Object.values(programs).map(program => {
        program.incomeUGX = program.incomeEUR * EXCHANGE_RATE;
        program.costsEUR = program.costsUGX / EXCHANGE_RATE;
        const deficitUGX = program.incomeUGX - program.costsUGX;
        const deficitEUR = deficitUGX / EXCHANGE_RATE;
        
        return {
            ...program,
            deficitEUR,
            deficitUGX
        };
    });
    
    const totalDeficitUGX = programArray.reduce((sum, program) => sum + program.deficitUGX, 0);
    const totalDeficitEUR = totalDeficitUGX / EXCHANGE_RATE;
    
    return {
        programs: programArray,
        totalDeficitEUR,
        totalDeficitUGX
    };
}

// ===== FINANCIAL CALCULATIONS =====
function calculateFinancialData(financialData) {
    const result = { ...financialData };
    
    // Convert all values to numbers
    Object.keys(result).forEach(key => {
        if (typeof result[key] === 'string' && result[key].startsWith('=')) {
            result[key] = evaluateFormula(result[key], result);
        } else if (result[key] === null || result[key] === undefined) {
            result[key] = 0;
        } else if (typeof result[key] === 'string') {
            result[key] = parseFloat(result[key]) || 0;
        }
    });
    
    // Calculate monthly costs if not provided
    if (!result.monthly_output_ugx || result.monthly_output_ugx === 0) {
        result.monthly_output_ugx = calculateMonthlyCostsUGX(result);
    }
    
    // Calculate derived values
    result.monthly_output_euro = result.monthly_output_ugx / EXCHANGE_RATE;
    result.cash_received_ugx = (result.cash_received_euro || 0) * EXCHANGE_RATE;
    result.plus_minus_diff_ugx = result.cash_received_ugx - result.monthly_output_ugx;
    result.plus_minus_diff_euro = result.plus_minus_diff_ugx / EXCHANGE_RATE;
    
    return result;
}

function calculateMonthlyCostsUGX(financialData) {
    const termlyFeesMonthly = (financialData.termly_school_fees || 0) / 3;
    const directSpending = financialData.direct_spending_school_fees_ugx_monthly || 0;
    const food = financialData.food || 0;
    const medical = financialData.average_medical || 0;
    const transport = financialData.school_personal_requirements_transport || 0;
    const admin = financialData.admin_utilities || 0;
    
    return termlyFeesMonthly + directSpending + food + medical + transport + admin;
}

function evaluateFormula(formula, data) {
    try {
        let expression = formula.substring(1);
        const replacements = {
            '\\$E\\$3': data.termly_school_fees || 0,
            '\\$D\\$3': data.termly_school_fees || 0,
            'D3': data.termly_school_fees || 0,
            'E3': data.direct_spending_school_fees_ugx_monthly || 0,
            'F3': data.direct_spending_school_fees_euros_monthly || 0,
            'G3': data.food || 0,
            'H3': data.average_medical || 0,
            'I3': data.school_personal_requirements_transport || 0,
            'J3': data.admin_utilities || 0
        };
        
        Object.entries(replacements).forEach(([pattern, value]) => {
            expression = expression.replace(new RegExp(pattern, 'g'), value);
        });
        
        expression = expression
            .replace(/(\d+)%/g, '$1/100')
            .replace(/SUM\(([^)]+)\)/g, (match, range) => {
                const parts = range.split(':');
                return parts.reduce((sum, part) => sum + (parseFloat(data[part]) || 0), 0);
            });
        
        const result = Function('"use strict"; return (' + expression + ')')();
        return typeof result === 'number' ? result : 0;
    } catch (error) {
        console.warn('Error evaluating formula:', formula, error);
        return 0;
    }
}

// ===== UI UPDATE FUNCTIONS =====
function updateUI() {
    updateFinancialSummary();
    renderFundingGapChart();
    renderProgramDistributionChart();
    renderAllStudentsTable();
    updateSponsorsUI();
    updateFinancialAnalysis();
    updateExpensesUI();
    updateEventsUI();
    updateForexUI();
    updateLastUpdated();
}

function updateFinancialSummary() {
    const totalStudents = financialSummary.totalStudents || 0;
    const totalIncomeUGX = financialSummary.totalIncomeUGX || 0;
    const totalCostsUGX = financialSummary.totalCostsUGX || 0;
    const totalDeficitUGX = financialSummary.totalDeficitUGX || 0;
    
    document.getElementById('total-students').textContent = totalStudents.toLocaleString();
    document.getElementById('total-income').textContent = formatCurrency(totalIncomeUGX, 'UGX');
    document.getElementById('total-costs').textContent = formatCurrency(totalCostsUGX, 'UGX');
    document.getElementById('total-deficit').textContent = formatCurrency(totalDeficitUGX, 'UGX');
    
    const deficitElement = document.getElementById('total-deficit');
    if (totalDeficitUGX < 0) {
        deficitElement.style.color = 'var(--danger)';
    } else if (totalDeficitUGX > 0) {
        deficitElement.style.color = 'var(--success)';
    } else {
        deficitElement.style.color = 'var(--gray)';
    }
}

function updateFinancialAnalysis() {
    // Calculate monthly, termly, and yearly expenses
    const monthlyExpenses = financialSummary.totalCostsUGX || 0;
    const termlyExpenses = monthlyExpenses * 3;
    const yearlyExpenses = monthlyExpenses * 12;
    const budgetBalance = financialSummary.totalIncomeUGX - financialSummary.totalCostsUGX;
    
    document.getElementById('monthly-expenses').textContent = formatCurrency(monthlyExpenses, 'UGX');
    document.getElementById('termly-expenses').textContent = formatCurrency(termlyExpenses, 'UGX');
    document.getElementById('yearly-expenses').textContent = formatCurrency(yearlyExpenses, 'UGX');
    document.getElementById('budget-balance').textContent = formatCurrency(budgetBalance, 'UGX');
    
    // Update charts
    renderExpenseBreakdownChart();
    renderIncomeExpenseTrendChart();
}

function updateExpensesUI() {
    const schoolExpensesBody = document.getElementById('school-expenses-body');
    const medicalExpensesBody = document.getElementById('medical-expenses-body');
    const transportExpensesBody = document.getElementById('transport-expenses-body');
    
    // Clear existing data
    schoolExpensesBody.innerHTML = '';
    medicalExpensesBody.innerHTML = '';
    transportExpensesBody.innerHTML = '';
    
    // Group expenses by category
    const schoolExpenses = dailyExpenses.filter(expense => expense.category === 'school');
    const medicalExpenses = dailyExpenses.filter(expense => expense.category === 'medical');
    const transportExpenses = dailyExpenses.filter(expense => expense.category === 'transport');
    
    // Populate school expenses
    if (schoolExpenses.length === 0) {
        schoolExpensesBody.innerHTML = '<tr><td colspan="5" class="empty-state">No school expenses recorded</td></tr>';
    } else {
        schoolExpenses.forEach(expense => {
            const student = allStudents.find(s => s.serial_number === expense.studentId) || {};
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(expense.date)}</td>
                <td>${student.full_name || 'Unknown'}</td>
                <td>${expense.description}</td>
                <td>${formatCurrency(expense.amount, expense.currency)}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteExpense(${expense.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            schoolExpensesBody.appendChild(row);
        });
    }
    
    // Populate medical expenses
    if (medicalExpenses.length === 0) {
        medicalExpensesBody.innerHTML = '<tr><td colspan="5" class="empty-state">No medical expenses recorded</td></tr>';
    } else {
        medicalExpenses.forEach(expense => {
            const student = allStudents.find(s => s.serial_number === expense.studentId) || {};
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(expense.date)}</td>
                <td>${student.full_name || 'Unknown'}</td>
                <td>${expense.description}</td>
                <td>${formatCurrency(expense.amount, expense.currency)}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteExpense(${expense.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            medicalExpensesBody.appendChild(row);
        });
    }
    
    // Populate transport expenses
    if (transportExpenses.length === 0) {
        transportExpensesBody.innerHTML = '<tr><td colspan="5" class="empty-state">No transport expenses recorded</td></tr>';
    } else {
        transportExpenses.forEach(expense => {
            const student = allStudents.find(s => s.serial_number === expense.studentId) || {};
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(expense.date)}</td>
                <td>${student.full_name || 'Unknown'}</td>
                <td>${expense.description}</td>
                <td>${formatCurrency(expense.amount, expense.currency)}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteExpense(${expense.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            transportExpensesBody.appendChild(row);
        });
    }
}

function updateEventsUI() {
    const eventsContainer = document.getElementById('events-container');
    eventsContainer.innerHTML = '';
    
    // Sort events by date
    const sortedEvents = [...events].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    if (sortedEvents.length === 0) {
        eventsContainer.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-calendar-alt"></i>
                <h4>No Upcoming Events</h4>
                <p>Add events to get reminders for important dates and deadlines</p>
            </div>
        `;
        return;
    }
    
    sortedEvents.forEach(event => {
        const eventDate = new Date(event.date);
        const today = new Date();
        const timeDiff = eventDate.getTime() - today.getTime();
        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
        
        let eventClass = 'event-card';
        if (daysDiff < 0) {
            eventClass += ' urgent';
        } else if (daysDiff <= 7) {
            eventClass += ' upcoming';
        }
        
        const eventElement = document.createElement('div');
        eventElement.className = eventClass;
        eventElement.innerHTML = `
            <div>
                <h4>${event.title}</h4>
                <p>${event.description || 'No description provided'}</p>
                <small>Type: ${event.type} | Priority: ${event.priority}</small>
            </div>
            <div>
                <div class="event-date">${formatDate(event.date)}</div>
                <div style="margin-top: 10px;">
                    <button class="btn btn-danger btn-sm" onclick="deleteEvent(${event.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        eventsContainer.appendChild(eventElement);
    });
}

function updateForexUI() {
    document.getElementById('eur-to-ugx-rate').textContent = `1 EUR = ${EXCHANGE_RATE.toLocaleString()} UGX`;
    document.getElementById('forex-update-time').textContent = 'Just now';
}

function formatCurrency(amount, currency) {
    if (currency === 'EUR') {
        return '€' + (amount || 0).toLocaleString();
    } else {
        return 'UGX ' + (amount || 0).toLocaleString();
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}

// ===== CHART FUNCTIONS =====
function renderFundingGapChart() {
    const ctx = document.getElementById('funding-gap-chart');
    if (!ctx) return;
    
    const parent = ctx.parentElement;
    
    if (fundingChart) fundingChart.destroy();
    
    if (!fundingGap.programs || fundingGap.programs.length === 0) {
        parent.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-chart-bar"></i>
                <h4>No Funding Data</h4>
                <p>Funding gap analysis will appear here once data is available</p>
            </div>`;
        return;
    }

    const programs = fundingGap.programs;
    const labels = programs.map(p => p.name);
    const incomeData = programs.map(p => p.incomeUGX / 1000);
    const costsData = programs.map(p => p.costsUGX / 1000);
    const deficitData = programs.map(p => Math.abs(p.deficitUGX) / 1000);

    fundingChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Income (UGX)',
                    data: incomeData,
                    backgroundColor: 'rgba(39, 174, 96, 0.8)',
                    borderColor: 'rgba(39, 174, 96, 1)',
                    borderWidth: 2,
                    borderRadius: 4
                },
                {
                    label: 'Costs (UGX)',
                    data: costsData,
                    backgroundColor: 'rgba(243, 156, 18, 0.8)',
                    borderColor: 'rgba(243, 156, 18, 1)',
                    borderWidth: 2,
                    borderRadius: 4
                },
                {
                    label: 'Deficit (UGX)',
                    data: deficitData,
                    backgroundColor: 'rgba(231, 76, 60, 0.8)',
                    borderColor: 'rgba(231, 76, 60, 1)',
                    borderWidth: 2,
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Funding Gap Analysis by Program (Thousands UGX)',
                    font: { size: 16, weight: 'bold' },
                    padding: 20
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            const value = context.parsed.y * 1000;
                            label += 'UGX ' + value.toLocaleString();
                            return label;
                        }
                    }
                },
                legend: {
                    position: 'top',
                    labels: { padding: 15, usePointStyle: true }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Amount (Thousands UGX)' },
                    ticks: {
                        callback: function(value) {
                            return 'UGX ' + value.toLocaleString() + 'K';
                        }
                    }
                },
                x: {
                    title: { display: true, text: 'Programs' },
                    grid: { display: false }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });
}

function renderProgramDistributionChart() {
    const ctx = document.getElementById('program-distribution-chart');
    if (!ctx) return;
    
    const parent = ctx.parentElement;
    
    if (programChart) programChart.destroy();
    
    const programStats = calculateProgramStatistics();
    
    if (!programStats || programStats.length === 0) {
        parent.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-chart-pie"></i>
                <h4>No Program Data</h4>
                <p>Program distribution data will appear here once available</p>
            </div>`;
        return;
    }

    const labels = programStats.map(p => p.name);
    const studentCounts = programStats.map(p => p.studentCount);

    programChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: studentCounts,
                backgroundColor: [
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(155, 89, 182, 0.8)',
                    'rgba(46, 204, 113, 0.8)',
                    'rgba(241, 196, 15, 0.8)',
                    'rgba(230, 126, 34, 0.8)',
                    'rgba(231, 76, 60, 0.8)'
                ],
                borderColor: [
                    'rgba(52, 152, 219, 1)',
                    'rgba(155, 89, 182, 1)',
                    'rgba(46, 204, 113, 1)',
                    'rgba(241, 196, 15, 1)',
                    'rgba(230, 126, 34, 1)',
                    'rgba(231, 76, 60, 1)'
                ],
                borderWidth: 2,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Student Distribution by Program',
                    font: { size: 16, weight: 'bold' },
                    padding: 20
                },
                legend: {
                    position: 'right',
                    labels: { padding: 15, usePointStyle: true, font: { size: 11 } }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} students (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });
}

function renderExpenseBreakdownChart() {
    const ctx = document.getElementById('expense-breakdown-chart');
    if (!ctx) return;
    
    const parent = ctx.parentElement;
    
    if (expenseChart) expenseChart.destroy();
    
    // Calculate expense breakdown by category
    const expenseCategories = {
        'School': 0,
        'Medical': 0,
        'Transport': 0,
        'Food': 0,
        'Other': 0
    };
    
    dailyExpenses.forEach(expense => {
        const category = expense.category ? expense.category.charAt(0).toUpperCase() + expense.category.slice(1) : 'Other';
        if (expenseCategories.hasOwnProperty(category)) {
            expenseCategories[category] += expense.amount || 0;
        } else {
            expenseCategories['Other'] += expense.amount || 0;
        }
    });
    
    const labels = Object.keys(expenseCategories);
    const data = Object.values(expenseCategories);
    
    // Check if there are any expenses
    const totalExpenses = data.reduce((sum, value) => sum + value, 0);
    if (totalExpenses === 0) {
        parent.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-chart-pie"></i>
                <h4>No Expense Data</h4>
                <p>Expense breakdown will appear here once expenses are recorded</p>
            </div>`;
        return;
    }

    expenseChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(231, 76, 60, 0.8)',
                    'rgba(46, 204, 113, 0.8)',
                    'rgba(241, 196, 15, 0.8)',
                    'rgba(155, 89, 182, 0.8)'
                ],
                borderColor: [
                    'rgba(52, 152, 219, 1)',
                    'rgba(231, 76, 60, 1)',
                    'rgba(46, 204, 113, 1)',
                    'rgba(241, 196, 15, 1)',
                    'rgba(155, 89, 182, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Expense Breakdown by Category',
                    font: { size: 16, weight: 'bold' },
                    padding: 20
                },
                legend: {
                    position: 'right',
                    labels: { padding: 15, usePointStyle: true }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: UGX ${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });
}

function renderIncomeExpenseTrendChart() {
    const ctx = document.getElementById('income-expense-trend-chart');
    if (!ctx) return;
    
    const parent = ctx.parentElement;
    
    if (trendChart) trendChart.destroy();
    
    // Generate sample trend data (in a real app, this would come from historical data)
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const incomeData = months.map(() => Math.floor(Math.random() * 5000000) + 2000000);
    const expenseData = months.map(() => Math.floor(Math.random() * 4500000) + 1800000);
    
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Income',
                    data: incomeData,
                    borderColor: 'rgba(39, 174, 96, 1)',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Expenses',
                    data: expenseData,
                    borderColor: 'rgba(231, 76, 60, 1)',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Income vs Expenses Trend',
                    font: { size: 16, weight: 'bold' },
                    padding: 20
                },
                legend: {
                    position: 'top',
                    labels: { padding: 15, usePointStyle: true }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: UGX ${context.parsed.y.toLocaleString()}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Amount (UGX)' },
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000000) {
                                return 'UGX ' + (value / 1000000).toFixed(1) + 'M';
                            } else if (value >= 1000) {
                                return 'UGX ' + (value / 1000).toFixed(0) + 'K';
                            } else {
                                return 'UGX ' + value;
                            }
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });
}

function calculateProgramStatistics() {
    const programs = {};
    allStudents.forEach(student => {
        if (!programs[student.program]) {
            programs[student.program] = { name: student.program, studentCount: 0 };
        }
        programs[student.program].studentCount++;
    });
    return Object.values(programs);
}

// ===== SPONSORS MANAGEMENT =====
function updateSponsorsUI() {
    updateSponsorsSummary();
    renderSponsorsTable();
}

function updateSponsorsSummary() {
    const totalSponsors = allSponsors.length;
    const activeSponsors = allSponsors.filter(s => s.sponsorship_status === 'active').length;
    const inactiveSponsors = allSponsors.filter(s => s.sponsorship_status === 'inactive').length;
    
    const activeSponsorsIncome = allSponsors
        .filter(s => s.sponsorship_status === 'active')
        .reduce((sum, sponsor) => sum + (parseFloat(sponsor.amount) || 0), 0);
    
    document.getElementById('total-sponsors').textContent = totalSponsors.toLocaleString();
    document.getElementById('active-sponsors').textContent = activeSponsors.toLocaleString();
    document.getElementById('inactive-sponsors').textContent = inactiveSponsors.toLocaleString();
    document.getElementById('active-sponsors-income').textContent = `€${activeSponsorsIncome.toFixed(2)}`;
}

function renderSponsorsTable() {
    const tableBody = document.getElementById('sponsors-table-body');
    if (!tableBody) return;
    
    if (allSponsors.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="9">
                    <div class="empty-state">
                        <i class="fas fa-hand-holding-usd"></i>
                        <h4>No Sponsors Found</h4>
                        <p>No sponsor records found in the registry. Add sponsors to get started.</p>
                    </div>
                </td>
            </tr>`;
        return;
    }
    
    tableBody.innerHTML = allSponsors.map(sponsor => {
        const amountUGX = (sponsor.amount || 0) * EXCHANGE_RATE;
        const statusClass = sponsor.sponsorship_status === 'active' ? 'status-active' : 
                        sponsor.sponsorship_status === 'inactive' ? 'status-inactive' : 'status-pending';
        
        return `
            <tr>
                <td>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #27ae60, #2ecc71); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                            ${sponsor.sponsor ? sponsor.sponsor.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : '??'}
                        </div>
                        <div>
                            <div style="font-weight: 600; color: var(--dark);">${sponsor.sponsor || 'Unknown Sponsor'}</div>
                            <div style="font-size: 0.8rem; color: var(--gray);">${sponsor.category || 'Individual'}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <div style="font-weight: 600; color: var(--secondary);">${sponsor.full_name || 'No student assigned'}</div>
                    ${sponsor.full_name ? `<div style="font-size: 0.8rem; color: var(--gray);">Student</div>` : ''}
                </td>
                <td><span class="status-badge">${sponsor.program}</span></td>
                <td>
                    <div style="font-weight: 600; color: var(--success);">€${(sponsor.amount || 0).toFixed(2)}</div>
                    <div style="font-size: 0.8rem; color: var(--gray);">Monthly</div>
                </td>
                <td>
                    <div style="font-weight: 600; color: var(--warning);">${formatCurrency(amountUGX, 'UGX')}</div>
                    <div style="font-size: 0.8rem; color: var(--gray);">Monthly</div>
                </td>
                <td><span class="status-badge ${statusClass}">${sponsor.sponsorship_status || 'active'}</span></td>
                <td>${sponsor.category || 'Individual'}</td>
                <td>
                    <div style="font-weight: 600; color: var(--dark);">${sponsor.start_date ? new Date(sponsor.start_date).toLocaleDateString() : 'Not set'}</div>
                    ${sponsor.start_date ? `<div style="font-size: 0.8rem; color: var(--gray);">Start Date</div>` : ''}
                </td>
                <td>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary btn-sm" onclick="editSponsor('${sponsor.program}', ${sponsor.cid})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-info btn-sm" onclick="viewSponsorDetails('${sponsor.program}', ${sponsor.cid})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSponsor('${sponsor.program}', ${sponsor.cid})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// ===== STUDENTS MANAGEMENT =====
function renderAllStudentsTable() {
    const tableBody = document.getElementById('students-table-body');
    if (!tableBody) return;
    
    if (allStudents.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="9">
                    <div class="empty-state">
                        <i class="fas fa-user-graduate"></i>
                        <h4>No Students Found</h4>
                        <p>No student records found in the database.</p>
                    </div>
                </td>
            </tr>`;
        return;
    }
    
    tableBody.innerHTML = allStudents.map(student => {
        const financials = student.calculated_financials || {};
        const balanceUGX = financials.plus_minus_diff_ugx || 0;
        const balanceClass = balanceUGX >= 0 ? 'positive' : 'negative';
        const balanceText = balanceUGX >= 0 ? 
            `+${formatCurrency(balanceUGX, 'UGX')}` : 
            `-${formatCurrency(Math.abs(balanceUGX), 'UGX')}`;
        
        return `
            <tr>
                <td>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                            ${student.full_name ? student.full_name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : '??'}
                        </div>
                        <div>
                            <div style="font-weight: 600; color: var(--dark);">${student.full_name || 'Unknown Student'}</div>
                            <div style="font-size: 0.8rem; color: var(--gray);">${student.program_name || student.program}</div>
                        </div>
                    </div>
                </td>
                <td><span class="status-badge status-active">${student.program}</span></td>
                <td>${student.sponsorship_package || 'Not specified'}</td>
                <td>
                    <div style="font-weight: 600; color: var(--dark);">${formatCurrency(financials.termly_school_fees || 0, 'UGX')}</div>
                    <div style="font-size: 0.8rem; color: var(--gray);">Termly</div>
                </td>
                <td>
                    <div style="font-weight: 600; color: var(--success);">€${(financials.cash_received_euro || 0).toFixed(2)}</div>
                    <div style="font-size: 0.8rem; color: var(--gray);">${formatCurrency((financials.cash_received_euro || 0) * EXCHANGE_RATE, 'UGX')}</div>
                </td>
                <td>
                    <div style="font-weight: 600; color: var(--warning);">${formatCurrency(financials.monthly_output_ugx || 0, 'UGX')}</div>
                    <div style="font-size: 0.8rem; color: var(--gray);">Monthly</div>
                </td>
                <td>
                    <span class="${balanceClass}" style="font-weight: 700; font-size: 1rem;">${balanceText}</span>
                </td>
                <td><span class="status-badge status-active">Active</span></td>
                <td>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary btn-sm" onclick="editStudent('${student.program}', ${student.serial_number})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-info btn-sm" onclick="viewStudentDetails('${student.program}', ${student.serial_number})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteStudent('${student.program}', ${student.serial_number})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// ===== EVENT HANDLERS =====
function setupEventListeners() {
    // Core functionality
    document.getElementById('sync-now')?.addEventListener('click', loadData);
    document.getElementById('refresh-data')?.addEventListener('click', loadData);
    document.getElementById('export-data')?.addEventListener('click', exportData);
    document.getElementById('add-student-btn')?.addEventListener('click', () => showStudentModal());
    document.getElementById('perform-search')?.addEventListener('click', performAdvancedSearch);
    document.getElementById('global-search')?.addEventListener('input', performGlobalSearch);
    document.getElementById('connection-toggle')?.addEventListener('click', toggleConnectionMode);
    document.getElementById('ai-assistant-toggle')?.addEventListener('click', toggleAIChat);
    document.getElementById('ai-assistant-btn')?.addEventListener('click', toggleAIChat);
    document.getElementById('ai-chat-close')?.addEventListener('click', toggleAIChat);
    document.getElementById('ai-chat-send')?.addEventListener('click', sendAIMessage);
    document.getElementById('ai-chat-input')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendAIMessage();
    });
    
    // Sponsors event listeners
    setupSponsorsEventListeners();
    
    // Expenses event listeners
    document.getElementById('add-expense-btn')?.addEventListener('click', () => showExpenseModal());
    document.getElementById('refresh-expenses')?.addEventListener('click', loadData);
    
    // Events event listeners
    document.getElementById('add-event-btn')?.addEventListener('click', () => showEventModal());
    document.getElementById('refresh-events')?.addEventListener('click', loadData);
    
    // Forex event listeners
    document.getElementById('update-forex')?.addEventListener('click', updateForexRates);
    document.getElementById('convert-currency')?.addEventListener('click', convertCurrency);
    
    // Settings event listeners
    document.getElementById('logo-upload-area')?.addEventListener('click', () => document.getElementById('logo-upload').click());
    document.getElementById('logo-upload')?.addEventListener('change', handleLogoUpload);
    
    // Search filters
    ['search-type', 'search-program', 'search-status', 'search-package'].forEach(filter => {
        const element = document.getElementById(filter);
        if (element) {
            element.addEventListener('change', performAdvancedSearch);
        }
    });
}

function setupSponsorsEventListeners() {
    document.getElementById('add-sponsor-btn')?.addEventListener('click', () => showSponsorModal());
    document.getElementById('export-sponsors')?.addEventListener('click', exportSponsorsData);
    document.getElementById('refresh-sponsors')?.addEventListener('click', loadData);
    
    // Sponsor modal events
    const sponsorModal = document.getElementById('sponsor-modal');
    if (sponsorModal) {
        const closeButtons = sponsorModal.querySelectorAll('.close, #cancel-sponsor');
        
        closeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                sponsorModal.style.display = 'none';
            });
        });
        
        window.addEventListener('click', (event) => {
            if (event.target === sponsorModal) {
                sponsorModal.style.display = 'none';
            }
        });
        
        document.getElementById('sponsor-form')?.addEventListener('submit', handleSponsorSubmit);
        document.getElementById('sponsor-program')?.addEventListener('change', updateSponsoredStudentsDropdown);
    }
}

function setupModals() {
    // Student modal
    const studentModal = document.getElementById('student-modal');
    if (studentModal) {
        const closeButtons = studentModal.querySelectorAll('.close, #cancel-student');
        
        closeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                studentModal.style.display = 'none';
            });
        });
        
        window.addEventListener('click', (event) => {
            if (event.target === studentModal) {
                studentModal.style.display = 'none';
            }
        });
        
        document.getElementById('student-form')?.addEventListener('submit', handleStudentSubmit);
    }
    
    // Expense modal
    const expenseModal = document.getElementById('expense-modal');
    if (expenseModal) {
        const expenseCloseButtons = expenseModal.querySelectorAll('.close, #cancel-expense');
        
        expenseCloseButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                expenseModal.style.display = 'none';
            });
        });
        
        window.addEventListener('click', (event) => {
            if (event.target === expenseModal) {
                expenseModal.style.display = 'none';
            }
        });
        
        document.getElementById('expense-form')?.addEventListener('submit', handleExpenseSubmit);
    }
    
    // Event modal
    const eventModal = document.getElementById('event-modal');
    if (eventModal) {
        const eventCloseButtons = eventModal.querySelectorAll('.close, #cancel-event');
        
        eventCloseButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                eventModal.style.display = 'none';
            });
        });
        
        window.addEventListener('click', (event) => {
            if (event.target === eventModal) {
                eventModal.style.display = 'none';
            }
        });
        
        document.getElementById('event-form')?.addEventListener('submit', handleEventSubmit);
    }
}

function setupNavigation() {
    const navItems = document.querySelectorAll('.nav-item');
    
    navItems.forEach(item => {
        item.addEventListener('click', function() {
            const section = this.getAttribute('data-section');
            navItems.forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
            navigateToSection(section);
        });
    });
}

function navigateToSection(section) {
    currentSection = section;
    const sections = [
        'dashboard', 'search-section', 'students-section', 'sponsors-section', 
        'financials-section', 'expenses-section', 'events-section',
        'forex-section', 'import-export-section', 'settings-section'
    ];
    
    // Hide all sections first
    sections.forEach(sec => {
        const element = document.getElementById(sec);
        if (element) element.style.display = 'none';
    });
    
    // Show the selected section
    const targetSection = document.getElementById(`${section}-section`);
    if (targetSection) {
        targetSection.style.display = 'block';
    } else if (section === 'dashboard') {
        // Show dashboard sections
        document.getElementById('search-section').style.display = 'block';
        document.getElementById('students-section').style.display = 'block';
    } else if (section === 'analytics') {
        // Analytics is part of dashboard
        navigateToSection('dashboard');
    }
    
    // Update charts and data for the specific section
    setTimeout(() => {
        switch(section) {
            case 'financials':
                updateFinancialAnalysis();
                break;
            case 'sponsors':
                updateSponsorsUI();
                break;
            case 'expenses':
                updateExpensesUI();
                break;
            case 'events':
                updateEventsUI();
                break;
            case 'forex':
                updateForexUI();
                break;
        }
    }, 100);
    
    // Scroll to top when navigating
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ===== MODAL MANAGEMENT =====
function showStudentModal(student = null) {
    const modal = document.getElementById('student-modal');
    if (!modal) return;
    
    const title = document.getElementById('student-modal-title');
    const form = document.getElementById('student-form');
    
    if (student) {
        title.textContent = 'Edit Student';
        document.getElementById('student-program').value = student.program;
        document.getElementById('full-name').value = student.full_name;
        document.getElementById('sponsorship-package').value = student.sponsorship_package;
        document.getElementById('termly-fees').value = student.calculated_financials?.termly_school_fees || 0;
        document.getElementById('cash-received').value = student.calculated_financials?.cash_received_euro || 0;
        document.getElementById('student-notes').value = student.notes || '';
        
        form.dataset.editingStudent = JSON.stringify(student);
    } else {
        title.textContent = 'Add New Student';
        form.reset();
        delete form.dataset.editingStudent;
    }
    
    modal.style.display = 'block';
}

function showSponsorModal(sponsor = null) {
    const modal = document.getElementById('sponsor-modal');
    if (!modal) return;
    
    const title = document.getElementById('sponsor-modal-title');
    const form = document.getElementById('sponsor-form');
    
    if (sponsor) {
        title.textContent = 'Edit Sponsor';
        document.getElementById('sponsor-program').value = sponsor.program;
        document.getElementById('sponsor-name').value = sponsor.sponsor;
        document.getElementById('sponsored-student').value = sponsor.full_name;
        document.getElementById('sponsor-amount').value = sponsor.amount;
        document.getElementById('sponsor-status').value = sponsor.sponsorship_status;
        document.getElementById('sponsor-category').value = sponsor.category;
        document.getElementById('sponsor-start-date').value = sponsor.start_date;
        document.getElementById('sponsor-notes').value = sponsor.notes || '';
        
        form.dataset.editingSponsor = JSON.stringify(sponsor);
    } else {
        title.textContent = 'Add New Sponsor';
        form.reset();
        document.getElementById('sponsor-start-date').value = new Date().toISOString().split('T')[0];
        delete form.dataset.editingSponsor;
    }
    
    // Populate students dropdown
    updateSponsoredStudentsDropdown();
    
    modal.style.display = 'block';
}

function updateSponsoredStudentsDropdown() {
    const program = document.getElementById('sponsor-program')?.value;
    const studentDropdown = document.getElementById('sponsored-student');
    
    if (!studentDropdown) return;
    
    // Clear existing options except the first one
    while (studentDropdown.options.length > 1) {
        studentDropdown.remove(1);
    }
    
    if (program) {
        const programStudents = allStudents.filter(student => student.program === program);
        programStudents.forEach(student => {
            const option = document.createElement('option');
            option.value = student.full_name;
            option.textContent = student.full_name;
            studentDropdown.appendChild(option);
        });
    }
}

// ===== FORM HANDLERS =====
async function handleStudentSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const program = document.getElementById('student-program')?.value;
    const fullName = document.getElementById('full-name')?.value;
    const sponsorshipPackage = document.getElementById('sponsorship-package')?.value;
    const termlyFees = parseFloat(document.getElementById('termly-fees')?.value) || 0;
    const cashReceived = parseFloat(document.getElementById('cash-received')?.value) || 0;
    const notes = document.getElementById('student-notes')?.value;
    
    if (!program || !fullName || !sponsorshipPackage) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    const studentData = {
        program,
        full_name: fullName,
        sponsorship_package: sponsorshipPackage,
        financial_data: {
            termly_school_fees: termlyFees,
            cash_received_euro: cashReceived
        },
        notes
    };
    
    try {
        if (form.dataset.editingStudent) {
            const student = JSON.parse(form.dataset.editingStudent);
            studentData.serial_number = student.serial_number;
            
            // Update existing student
            const response = await fetch(`/api/programs/${program}/students/${student.serial_number}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(studentData)
            });
            
            if (!response.ok) throw new Error('Failed to update student');
        } else {
            // Add new student
            const response = await fetch(`/api/programs/${program}/students`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(studentData)
            });
            
            if (!response.ok) throw new Error('Failed to add student');
        }
        
        showNotification('Student saved successfully', 'success');
        document.getElementById('student-modal').style.display = 'none';
        
        // Reload data to reflect changes
        loadData();
        
    } catch (error) {
        console.error('Error saving student:', error);
        showNotification('Failed to save student', 'error');
    }
}

async function handleSponsorSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const program = document.getElementById('sponsor-program')?.value;
    const sponsorName = document.getElementById('sponsor-name')?.value;
    const sponsoredStudent = document.getElementById('sponsored-student')?.value;
    const amount = parseFloat(document.getElementById('sponsor-amount')?.value) || 0;
    const status = document.getElementById('sponsor-status')?.value;
    const category = document.getElementById('sponsor-category')?.value;
    const startDate = document.getElementById('sponsor-start-date')?.value;
    const notes = document.getElementById('sponsor-notes')?.value;
    
    if (!program || !sponsorName || !sponsoredStudent || !amount) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    const sponsorData = {
        program,
        sponsor: sponsorName,
        full_name: sponsoredStudent,
        amount,
        sponsorship_status: status,
        category,
        start_date: startDate,
        notes
    };
    
    try {
        if (form.dataset.editingSponsor) {
            const sponsor = JSON.parse(form.dataset.editingSponsor);
            sponsorData.cid = sponsor.cid;
            
            // Update existing sponsor
            const response = await fetch(`/api/registry/${program}/students/${sponsor.cid}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(sponsorData)
            });
            
            if (!response.ok) throw new Error('Failed to update sponsor');
        } else {
            // Add new sponsor
            const response = await fetch(`/api/registry/${program}/students`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(sponsorData)
            });
            
            if (!response.ok) throw new Error('Failed to add sponsor');
        }
        
        showNotification('Sponsor saved successfully', 'success');
        document.getElementById('sponsor-modal').style.display = 'none';
        
        // Reload data to reflect changes
        loadData();
        
    } catch (error) {
        console.error('Error saving sponsor:', error);
        showNotification('Failed to save sponsor', 'error');
    }
}

// ===== EXPENSE MANAGEMENT =====
function showExpenseModal(expense = null) {
    const modal = document.getElementById('expense-modal');
    if (!modal) return;
    
    const title = document.getElementById('expense-modal-title');
    const form = document.getElementById('expense-form');
    
    if (expense) {
        title.textContent = 'Edit Expense';
        document.getElementById('expense-date').value = expense.date;
        document.getElementById('expense-student').value = expense.studentId;
        document.getElementById('expense-category').value = expense.category;
        document.getElementById('expense-amount').value = expense.amount;
        document.getElementById('expense-description').value = expense.description;
        
        form.dataset.editingExpense = JSON.stringify(expense);
    } else {
        title.textContent = 'Add New Expense';
        form.reset();
        document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
        delete form.dataset.editingExpense;
    }
    
    // Populate students dropdown
    updateExpenseStudentsDropdown();
    
    modal.style.display = 'block';
}

function updateExpenseStudentsDropdown() {
    const studentDropdown = document.getElementById('expense-student');
    if (!studentDropdown) return;
    
    // Clear existing options except the first one
    while (studentDropdown.options.length > 1) {
        studentDropdown.remove(1);
    }
    
    allStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.serial_number;
        option.textContent = `${student.full_name} (${student.program})`;
        studentDropdown.appendChild(option);
    });
}

async function handleExpenseSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const date = document.getElementById('expense-date')?.value;
    const studentId = parseInt(document.getElementById('expense-student')?.value);
    const category = document.getElementById('expense-category')?.value;
    const amount = parseFloat(document.getElementById('expense-amount')?.value) || 0;
    const description = document.getElementById('expense-description')?.value;
    
    if (!date || !studentId || !category || !amount || !description) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    const expenseData = {
        date,
        studentId,
        category,
        amount,
        description,
        currency: 'UGX'
    };
    
    try {
        if (form.dataset.editingExpense) {
            const expense = JSON.parse(form.dataset.editingExpense);
            expenseData.id = expense.id;
            
            // Update existing expense
            const response = await fetch(`/api/expenses/${expense.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(expenseData)
            });
            
            if (!response.ok) throw new Error('Failed to update expense');
        } else {
            // Add new expense
            const response = await fetch('/api/expenses', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(expenseData)
            });
            
            if (!response.ok) throw new Error('Failed to add expense');
        }
        
        showNotification('Expense saved successfully', 'success');
        document.getElementById('expense-modal').style.display = 'none';
        
        // Update UI
        updateExpensesUI();
        updateFinancialAnalysis();
        
    } catch (error) {
        console.error('Error saving expense:', error);
        showNotification('Failed to save expense', 'error');
    }
}

function deleteExpense(expenseId) {
    if (!confirm('Are you sure you want to delete this expense?')) {
        return;
    }
    
    fetch(`/api/expenses/${expenseId}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to delete expense');
        showNotification('Expense deleted successfully', 'success');
        updateExpensesUI();
        updateFinancialAnalysis();
    })
    .catch(error => {
        console.error('Error deleting expense:', error);
        showNotification('Failed to delete expense', 'error');
    });
}

// ===== EVENT MANAGEMENT =====
function showEventModal(event = null) {
    const modal = document.getElementById('event-modal');
    if (!modal) return;
    
    const title = document.getElementById('event-modal-title');
    const form = document.getElementById('event-form');
    
    if (event) {
        title.textContent = 'Edit Event';
        document.getElementById('event-title').value = event.title;
        document.getElementById('event-date').value = event.date;
        document.getElementById('event-type').value = event.type;
        document.getElementById('event-priority').value = event.priority;
        document.getElementById('event-description').value = event.description || '';
        
        form.dataset.editingEvent = JSON.stringify(event);
    } else {
        title.textContent = 'Add New Event';
        form.reset();
        document.getElementById('event-date').value = new Date().toISOString().split('T')[0];
        delete form.dataset.editingEvent;
    }
    
    modal.style.display = 'block';
}

async function handleEventSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const title = document.getElementById('event-title')?.value;
    const date = document.getElementById('event-date')?.value;
    const type = document.getElementById('event-type')?.value;
    const priority = document.getElementById('event-priority')?.value;
    const description = document.getElementById('event-description')?.value;
    
    if (!title || !date || !type) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    const eventData = {
        title,
        date,
        type,
        priority,
        description
    };
    
    try {
        if (form.dataset.editingEvent) {
            const event = JSON.parse(form.dataset.editingEvent);
            eventData.id = event.id;
            
            // Update existing event
            const response = await fetch(`/api/events/${event.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(eventData)
            });
            
            if (!response.ok) throw new Error('Failed to update event');
        } else {
            // Add new event
            const response = await fetch('/api/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(eventData)
            });
            
            if (!response.ok) throw new Error('Failed to add event');
        }
        
        showNotification('Event saved successfully', 'success');
        document.getElementById('event-modal').style.display = 'none';
        
        // Update UI
        updateEventsUI();
        
    } catch (error) {
        console.error('Error saving event:', error);
        showNotification('Failed to save event', 'error');
    }
}

function deleteEvent(eventId) {
    if (!confirm('Are you sure you want to delete this event?')) {
        return;
    }
    
    fetch(`/api/events/${eventId}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to delete event');
        showNotification('Event deleted successfully', 'success');
        updateEventsUI();
    })
    .catch(error => {
        console.error('Error deleting event:', error);
        showNotification('Failed to delete event', 'error');
    });
}

function checkEventReminders() {
    const today = new Date();
    const upcomingEvents = events.filter(event => {
        const eventDate = new Date(event.date);
        const timeDiff = eventDate.getTime() - today.getTime();
        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
        return daysDiff >= 0 && daysDiff <= 7;
    });
    
    if (upcomingEvents.length > 0) {
        showNotification(`You have ${upcomingEvents.length} upcoming event(s) in the next 7 days`, 'info');
    }
}

// ===== FOREX EXCHANGE =====
function updateForexRates() {
    // In a real application, this would fetch from an API
    // For demo purposes, we'll use a fixed rate with slight variation
    const variation = (Math.random() * 200) - 100; // +/- 100 UGX
    EXCHANGE_RATE = Math.round(4100 + variation);
    
    document.getElementById('eur-to-ugx-rate').textContent = `1 EUR = ${EXCHANGE_RATE.toLocaleString()} UGX`;
    document.getElementById('forex-update-time').textContent = new Date().toLocaleTimeString();
    
    showNotification('Exchange rates updated successfully', 'success');
    
    // Update any calculations that use exchange rate
    processAllData();
    updateUI();
}

function convertCurrency() {
    const amount = parseFloat(document.getElementById('forex-amount')?.value) || 0;
    const fromCurrency = document.getElementById('forex-from')?.value;
    const toCurrency = document.getElementById('forex-to')?.value;
    
    if (amount <= 0) {
        showNotification('Please enter a valid amount', 'error');
        return;
    }
    
    let result;
    if (fromCurrency === 'EUR' && toCurrency === 'UGX') {
        result = amount * EXCHANGE_RATE;
    } else if (fromCurrency === 'UGX' && toCurrency === 'EUR') {
        result = amount / EXCHANGE_RATE;
    } else {
        result = amount; // Same currency
    }
    
    const resultElement = document.getElementById('conversion-result');
    if (resultElement) {
        resultElement.textContent = 
            `${amount.toLocaleString()} ${fromCurrency} = ${result.toLocaleString()} ${toCurrency}`;
    }
}

// ===== SETTINGS MANAGEMENT =====
function loadSettings() {
    const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
    
    // Organization settings
    if (settings.orgName) {
        document.getElementById('org-name').textContent = settings.orgName;
        document.getElementById('org-name-input').value = settings.orgName;
    }
    
    if (settings.defaultCurrency) {
        document.getElementById('org-currency').value = settings.defaultCurrency;
    }
    
    // Forex settings
    if (settings.manualExchangeRate) {
        EXCHANGE_RATE = settings.manualExchangeRate;
        document.getElementById('manual-exchange-rate').value = settings.manualExchangeRate;
    }
    
    if (settings.autoUpdateForex !== undefined) {
        document.getElementById('auto-update-forex').checked = settings.autoUpdateForex;
    }
    
    // Notification settings
    if (settings.emailNotifications !== undefined) {
        document.getElementById('email-notifications').checked = settings.emailNotifications;
    }
    
    if (settings.eventReminders !== undefined) {
        document.getElementById('event-reminders').checked = settings.eventReminders;
    }
    
    if (settings.lowBalanceAlerts !== undefined) {
        document.getElementById('low-balance-alerts').checked = settings.lowBalanceAlerts;
    }
    
    // Logo
    if (settings.logo) {
        document.getElementById('logo-preview').src = settings.logo;
        document.getElementById('logo-preview').style.display = 'block';
    }
    
    updateForexUI();
}

function saveOrgSettings() {
    const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
    
    settings.orgName = document.getElementById('org-name-input')?.value;
    settings.defaultCurrency = document.getElementById('org-currency')?.value;
    
    localStorage.setItem('appSettings', JSON.stringify(settings));
    
    document.getElementById('org-name').textContent = settings.orgName;
    
    showNotification('Organization settings saved successfully', 'success');
}

function saveForexSettings() {
    const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
    
    settings.manualExchangeRate = parseFloat(document.getElementById('manual-exchange-rate')?.value);
    settings.autoUpdateForex = document.getElementById('auto-update-forex')?.checked;
    
    localStorage.setItem('appSettings', JSON.stringify(settings));
    
    EXCHANGE_RATE = settings.manualExchangeRate;
    updateForexUI();
    
    showNotification('Forex settings saved successfully', 'success');
}

function saveNotificationSettings() {
    const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
    
    settings.emailNotifications = document.getElementById('email-notifications')?.checked;
    settings.eventReminders = document.getElementById('event-reminders')?.checked;
    settings.lowBalanceAlerts = document.getElementById('low-balance-alerts')?.checked;
    
    localStorage.setItem('appSettings', JSON.stringify(settings));
    
    showNotification('Notification settings saved successfully', 'success');
}

function handleLogoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const logoDataUrl = e.target.result;
        
        // Save to settings
        const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
        settings.logo = logoDataUrl;
        localStorage.setItem('appSettings', JSON.stringify(settings));
        
        // Update preview
        const logoPreview = document.getElementById('logo-preview');
        logoPreview.src = logoDataUrl;
        logoPreview.style.display = 'block';
        
        showNotification('Logo uploaded successfully', 'success');
    };
    
    reader.readAsDataURL(file);
}

// ===== IMPORT/EXPORT FUNCTIONALITY =====
function exportToExcel() {
    try {
        // Create workbook
        const wb = XLSX.utils.book_new();
        
        // Students sheet
        const studentsData = allStudents.map(student => ({
            'Full Name': student.full_name,
            'Program': student.program,
            'Sponsorship Package': student.sponsorship_package,
            'Termly Fees (UGX)': student.calculated_financials?.termly_school_fees || 0,
            'Monthly Cost (UGX)': student.calculated_financials?.monthly_output_ugx || 0,
            'Cash Received (EUR)': student.calculated_financials?.cash_received_euro || 0,
            'Balance (UGX)': student.calculated_financials?.plus_minus_diff_ugx || 0
        }));
        
        const studentsWS = XLSX.utils.json_to_sheet(studentsData);
        XLSX.utils.book_append_sheet(wb, studentsWS, 'Students');
        
        // Sponsors sheet
        const sponsorsData = allSponsors.map(sponsor => ({
            'Sponsor Name': sponsor.sponsor,
            'Sponsored Student': sponsor.full_name,
            'Program': sponsor.program,
            'Amount (EUR)': sponsor.amount,
            'Amount (UGX)': (sponsor.amount || 0) * EXCHANGE_RATE,
            'Status': sponsor.sponsorship_status,
            'Category': sponsor.category,
            'Start Date': sponsor.start_date
        }));
        
        const sponsorsWS = XLSX.utils.json_to_sheet(sponsorsData);
        XLSX.utils.book_append_sheet(wb, sponsorsWS, 'Sponsors');
        
        // Expenses sheet
        const expensesData = dailyExpenses.map(expense => {
            const student = allStudents.find(s => s.serial_number === expense.studentId) || {};
            return {
                'Date': expense.date,
                'Student': student.full_name || 'Unknown',
                'Category': expense.category,
                'Description': expense.description,
                'Amount (UGX)': expense.amount
            };
        });
        
        const expensesWS = XLSX.utils.json_to_sheet(expensesData);
        XLSX.utils.book_append_sheet(wb, expensesWS, 'Expenses');
        
        // Financial summary sheet
        const financialData = [{
            'Total Students': financialSummary.totalStudents,
            'Total Monthly Income (EUR)': financialSummary.totalIncomeEUR,
            'Total Monthly Income (UGX)': financialSummary.totalIncomeUGX,
            'Total Monthly Costs (EUR)': financialSummary.totalCostsEUR,
            'Total Monthly Costs (UGX)': financialSummary.totalCostsUGX,
            'Monthly Deficit (UGX)': financialSummary.totalDeficitUGX,
            'Exchange Rate': EXCHANGE_RATE
        }];
        
        const financialWS = XLSX.utils.json_to_sheet(financialData);
        XLSX.utils.book_append_sheet(wb, financialWS, 'Financial Summary');
        
        // Export to file
        const timestamp = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `sponsorship_data_${timestamp}.xlsx`);
        
        showNotification('Data exported to Excel successfully', 'success');
    } catch (error) {
        console.error('Error exporting to Excel:', error);
        showNotification('Failed to export data to Excel', 'error');
    }
}

function exportToPDF() {
    // In a real application, this would generate a proper PDF
    // For this demo, we'll create a simple HTML representation and use html2canvas
    
    const element = document.createElement('div');
    element.innerHTML = `
        <div style="padding: 20px; font-family: Arial, sans-serif;">
            <h1 style="text-align: center; color: #2c3e50;">Sponsorship Management Report</h1>
            <p style="text-align: center;">Generated on: ${new Date().toLocaleDateString()}</p>
            
            <h2>Financial Summary</h2>
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Metric</th>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Value</th>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">Total Students</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${financialSummary.totalStudents}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">Total Monthly Income</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(financialSummary.totalIncomeUGX, 'UGX')}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">Total Monthly Costs</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(financialSummary.totalCostsUGX, 'UGX')}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">Monthly Deficit</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(financialSummary.totalDeficitUGX, 'UGX')}</td>
                </tr>
            </table>
            
            <h2>Program Distribution</h2>
            <p>Total students across all programs: ${financialSummary.totalStudents}</p>
        </div>
    `;
    
    document.body.appendChild(element);
    
    html2canvas(element).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `sponsorship_report_${new Date().toISOString().split('T')[0]}.png`;
        link.href = imgData;
        link.click();
        
        document.body.removeChild(element);
        showNotification('Report exported as image successfully', 'success');
    });
}

function showImportModal() {
    document.getElementById('import-modal').style.display = 'block';
}

function backupData() {
    const backup = {
        database: database,
        expenses: dailyExpenses,
        events: events,
        settings: JSON.parse(localStorage.getItem('appSettings') || '{}'),
        timestamp: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(backup, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.download = `sponsorship_backup_${new Date().toISOString().split('T')[0]}.json`;
    link.href = URL.createObjectURL(dataBlob);
    link.click();
    
    showNotification('Data backup created successfully', 'success');
}

// ===== AI ASSISTANT =====
function toggleAIChat() {
    const chatBox = document.getElementById('ai-chat-box');
    if (chatBox.style.display === 'none') {
        chatBox.style.display = 'flex';
    } else {
        chatBox.style.display = 'none';
    }
}

function sendAIMessage() {
    const input = document.getElementById('ai-chat-input');
    const messagesContainer = document.getElementById('ai-chat-messages');
    const userMessage = input.value.trim();
    
    if (!userMessage) return;
    
    // Add user message
    const userMessageElement = document.createElement('div');
    userMessageElement.className = 'ai-chat-message user';
    userMessageElement.innerHTML = `<div class="ai-chat-bubble">${userMessage}</div>`;
    messagesContainer.appendChild(userMessageElement);
    
    input.value = '';
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Simulate AI response (in a real app, this would call an API)
    setTimeout(() => {
        const aiResponse = generateAIResponse(userMessage);
        const aiMessageElement = document.createElement('div');
        aiMessageElement.className = 'ai-chat-message ai';
        aiMessageElement.innerHTML = `<div class="ai-chat-bubble">${aiResponse}</div>`;
        messagesContainer.appendChild(aiMessageElement);
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 1000);
}

function generateAIResponse(userMessage) {
    const lowerMessage = userMessage.toLowerCase();
    
    if (lowerMessage.includes('student') || lowerMessage.includes('child')) {
        return `There are currently ${financialSummary.totalStudents} students in the sponsorship program. You can view detailed information in the Students section.`;
    } else if (lowerMessage.includes('sponsor') || lowerMessage.includes('donor')) {
        return `There are ${allSponsors.length} sponsors supporting our programs. The total monthly sponsorship is €${allSponsors.filter(s => s.sponsorship_status === 'active').reduce((sum, s) => sum + (s.amount || 0), 0).toFixed(2)}.`;
    } else if (lowerMessage.includes('financial') || lowerMessage.includes('budget')) {
        return `The current financial status: Monthly Income: ${formatCurrency(financialSummary.totalIncomeUGX, 'UGX')}, Monthly Costs: ${formatCurrency(financialSummary.totalCostsUGX, 'UGX')}, Deficit: ${formatCurrency(financialSummary.totalDeficitUGX, 'UGX')}.`;
    } else if (lowerMessage.includes('expense') || lowerMessage.includes('cost')) {
        const totalExpenses = dailyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
        return `Total recorded expenses: ${formatCurrency(totalExpenses, 'UGX')}. You can view detailed expense breakdown in the Daily Expenses section.`;
    } else {
        return "I'm here to help with sponsorship management. You can ask me about students, sponsors, financial information, or expenses. How can I assist you further?";
    }
}

// ===== UTILITY FUNCTIONS =====
function updateLastUpdated() {
    console.log(`🕒 Last updated: ${new Date().toLocaleString()}`);
}

function showNotification(message, type = 'success') {
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => {
        if (notification.parentNode) notification.parentNode.removeChild(notification);
    });
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${getNotificationIcon(type)}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) notification.parentNode.removeChild(notification);
    }, 5000);
}

function getNotificationIcon(type) {
    const icons = {
        success: 'check-circle',
        error: 'exclamation-triangle',
        warning: 'exclamation-circle',
        info: 'info-circle'
    };
    return icons[type] || 'info-circle';
}

function showLoading(loading) {
    const buttons = document.querySelectorAll('.btn:not(.close)');
    buttons.forEach(btn => {
        btn.disabled = loading;
        if (loading) {
            btn.classList.add('loading');
        } else {
            btn.classList.remove('loading');
        }
    });
}

function updateConnectionStatus(connected, mode) {
    const dot = document.getElementById('connection-dot');
    const text = document.getElementById('connection-text');
    
    if (!dot || !text) return;
    
    dot.className = 'status-dot';
    
    if (mode === 'offline') {
        dot.classList.add('offline');
        text.textContent = 'Offline';
    } else if (connected) {
        dot.classList.add('connected');
        text.textContent = 'Connected';
    } else {
        dot.classList.add('disconnected');
        text.textContent = 'Connecting...';
    }
}

function toggleConnectionMode() {
    isOnlineMode = !isOnlineMode;
    
    if (isOnlineMode) {
        updateConnectionStatus(false, 'online');
        initializeWebSocket();
        showNotification('Switched to Online Mode', 'info');
    } else {
        if (ws) ws.close();
        updateConnectionStatus(true, 'offline');
        showNotification('Switched to Offline Mode', 'warning');
    }
    
    loadData();
}

// ===== SAMPLE DATA FALLBACK =====
function loadSampleData() {
    console.log('📋 Loading sample data...');
    
    database = {
        sponsorship_programs: {
            "CH": {
                "program_name": "CH FINANCIAL ANALYSIS REPORT TERM III 2025",
                "students": [
                    {
                        "serial_number": 1,
                        "full_name": "LWANGA DESTINY ADRIAN",
                        "sponsorship_package": "Day",
                        "financial_data": {
                            "termly_school_fees": 500000,
                            "direct_spending_school_fees_ugx_monthly": 125000,
                            "food": 80000,
                            "average_medical": 20000,
                            "school_personal_requirements_transport": 20000,
                            "admin_utilities": 13500,
                            "cash_received_euro": 70
                        }
                    },
                    {
                        "serial_number": 2,
                        "full_name": "NAKATO PRECIOUS",
                        "sponsorship_package": "Boarding",
                        "financial_data": {
                            "termly_school_fees": 800000,
                            "direct_spending_school_fees_ugx_monthly": 200000,
                            "food": 120000,
                            "average_medical": 25000,
                            "school_personal_requirements_transport": 30000,
                            "admin_utilities": 15000,
                            "cash_received_euro": 100
                        }
                    }
                ]
            }
        },
        sponsorship_registry: {
            "CH": {
                "students": [
                    {
                        "cid": 1,
                        "full_name": "LWANGA DESTINY ADRIAN",
                        "sponsor": "Foundation X",
                        "amount": 70,
                        "sponsorship_status": "active",
                        "category": "Education"
                    },
                    {
                        "cid": 2,
                        "full_name": "NAKATO PRECIOUS",
                        "sponsor": "Organization Y",
                        "amount": 100,
                        "sponsorship_status": "active",
                        "category": "Education"
                    }
                ]
            }
        }
    };
    
    processAllData();
    updateUI();
    showNotification('Sample data loaded successfully', 'warning');
}

// ===== SEARCH FUNCTIONALITY =====
function performAdvancedSearch() {
    const searchType = document.getElementById('search-type')?.value || 'all';
    const program = document.getElementById('search-program')?.value || '';
    const status = document.getElementById('search-status')?.value || '';
    const packageType = document.getElementById('search-package')?.value || '';
    
    let results = [];
    
    if (searchType === 'students' || searchType === 'all') {
        results = results.concat(allStudents.filter(student => {
            return (!program || student.program === program) &&
                   (!status || student.status === status) &&
                   (!packageType || student.sponsorship_package === packageType);
        }));
    }
    
    if (searchType === 'sponsors' || searchType === 'all') {
        results = results.concat(allSponsors.filter(sponsor => {
            return (!program || sponsor.program === program) &&
                   (!status || sponsor.sponsorship_status === status);
        }));
    }
    
    displaySearchResults(results);
}

function performGlobalSearch() {
    const searchTerm = document.getElementById('global-search')?.value.toLowerCase() || '';
    
    if (!searchTerm) {
        // Clear search results if search term is empty
        const searchResults = document.getElementById('search-results');
        if (searchResults) {
            searchResults.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <h4>No Search Results</h4>
                    <p>Use the search filters above to find students, sponsors, or program records</p>
                </div>`;
        }
        return;
    }
    
    const results = [];
    
    // Search in students
    allStudents.forEach(student => {
        if (student.full_name?.toLowerCase().includes(searchTerm) ||
            student.program?.toLowerCase().includes(searchTerm) ||
            student.sponsorship_package?.toLowerCase().includes(searchTerm)) {
            results.push({ ...student, type: 'student' });
        }
    });
    
    // Search in sponsors
    allSponsors.forEach(sponsor => {
        if (sponsor.sponsor?.toLowerCase().includes(searchTerm) ||
            sponsor.full_name?.toLowerCase().includes(searchTerm) ||
            sponsor.program?.toLowerCase().includes(searchTerm) ||
            sponsor.category?.toLowerCase().includes(searchTerm)) {
            results.push({ ...sponsor, type: 'sponsor' });
        }
    });
    
    displaySearchResults(results);
}

function displaySearchResults(results) {
    const searchResults = document.getElementById('search-results');
    if (!searchResults) return;
    
    if (results.length === 0) {
        searchResults.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h4>No Results Found</h4>
                <p>Try adjusting your search criteria or filters</p>
            </div>`;
        return;
    }
    
    searchResults.innerHTML = results.map(item => {
        if (item.type === 'student') {
            const financials = item.calculated_financials || {};
            return `
                <div class="result-card">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div>
                            <h4 style="margin: 0 0 8px 0; color: var(--dark);">
                                <i class="fas fa-user-graduate" style="color: var(--secondary); margin-right: 8px;"></i>
                                ${item.full_name}
                            </h4>
                            <p style="margin: 0; color: var(--gray);">
                                <strong>Program:</strong> ${item.program} | 
                                <strong>Package:</strong> ${item.sponsorship_package} |
                                <strong>Monthly Cost:</strong> ${formatCurrency(financials.monthly_output_ugx || 0, 'UGX')}
                            </p>
                        </div>
                        <span class="status-badge status-active">Student</span>
                    </div>
                </div>`;
        } else {
            return `
                <div class="result-card">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div>
                            <h4 style="margin: 0 0 8px 0; color: var(--dark);">
                                <i class="fas fa-hand-holding-usd" style="color: var(--success); margin-right: 8px;"></i>
                                ${item.sponsor}
                            </h4>
                            <p style="margin: 0; color: var(--gray);">
                                <strong>Student:</strong> ${item.full_name} | 
                                <strong>Program:</strong> ${item.program} |
                                <strong>Amount:</strong> €${item.amount} (${formatCurrency((item.amount || 0) * EXCHANGE_RATE, 'UGX')})
                            </p>
                        </div>
                        <span class="status-badge ${item.sponsorship_status === 'active' ? 'status-active' : 'status-inactive'}">Sponsor</span>
                    </div>
                </div>`;
        }
    }).join('');
}

// ===== GLOBAL EXPORTS =====
window.editStudent = function(program, studentId) {
    const student = allStudents.find(s => s.program === program && s.serial_number === studentId);
    if (student) {
        showStudentModal(student);
    }
};

window.viewStudentDetails = function(program, studentId) {
    const student = allStudents.find(s => s.program === program && s.serial_number === studentId);
    if (student) {
        alert(`Student Details:\n\nName: ${student.full_name}\nProgram: ${student.program}\nPackage: ${student.sponsorship_package}\nMonthly Cost: ${formatCurrency(student.calculated_financials?.monthly_output_ugx || 0, 'UGX')}`);
    }
};

window.deleteStudent = function(program, studentId) {
    if (confirm('Are you sure you want to delete this student?')) {
        fetch(`/api/programs/${program}/students/${studentId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to delete student');
            showNotification('Student deleted successfully', 'success');
            loadData();
        })
        .catch(error => {
            console.error('Error deleting student:', error);
            showNotification('Failed to delete student', 'error');
        });
    }
};

window.editSponsor = function(program, sponsorId) {
    const sponsor = allSponsors.find(s => s.program === program && s.cid === sponsorId);
    if (sponsor) {
        showSponsorModal(sponsor);
    }
};

window.viewSponsorDetails = function(program, sponsorId) {
    const sponsor = allSponsors.find(s => s.program === program && s.cid === sponsorId);
    if (sponsor) {
        alert(`Sponsor Details:\n\nName: ${sponsor.sponsor}\nStudent: ${sponsor.full_name}\nProgram: ${sponsor.program}\nAmount: €${sponsor.amount}\nStatus: ${sponsor.sponsorship_status}`);
    }
};

window.deleteSponsor = function(program, sponsorId) {
    if (confirm('Are you sure you want to delete this sponsor?')) {
        fetch(`/api/registry/${program}/students/${sponsorId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to delete sponsor');
            showNotification('Sponsor deleted successfully', 'success');
            loadData();
        })
        .catch(error => {
            console.error('Error deleting sponsor:', error);
            showNotification('Failed to delete sponsor', 'error');
        });
    }
};

window.refreshCharts = function() {
    renderFundingGapChart();
    renderProgramDistributionChart();
    renderExpenseBreakdownChart();
    renderIncomeExpenseTrendChart();
    showNotification('Charts refreshed successfully', 'success');
};

window.exportChartData = function() {
    exportToExcel();
};

window.exportData = function() {
    exportToExcel();
};

window.exportSponsorsData = function() {
    exportToExcel();
};

console.log('✅ Sponsorship Management System Frontend Loaded!');
    </script>
</body>
</html>
